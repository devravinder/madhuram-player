import{st as e}from"./index-BLjs2o18.js";import{C as t,D as n,_ as r,o as i,s as a,t as o,y as s}from"./BasicParser-_YdBDVKJ.js";import{i as c,n as l}from"./core-SrxPbndD.js";import{c as u}from"./Util-650YjRsD.js";import"./ID3v2Token-D9rStPQo.js";import{i as d}from"./APEv2Parser-BB3KA6i1.js";import"./ID3v1Parser-D73-tQHy.js";import{t as f}from"./ID3v2Parser-BNgf2RC4.js";var p=e(a(),1);const m={len:8,get:(e,n)=>({chunkID:new r(4,`latin1`).get(e,n),chunkSize:t.get(e,n+4)})};var h=class{constructor(e){this.tagHeader=e,this.len=e.chunkSize,this.len+=this.len&1}get(e,t){return new r(this.tagHeader.chunkSize,`ascii`).get(e,t)}},g=class extends i(`Wave`){};const _={PCM:1,ADPCM:2,IEEE_FLOAT:3,MPEG_ADTS_AAC:5632,MPEG_LOAS:5634,RAW_AAC1:255,DOLBY_AC3_SPDIF:146,DVM:8192,RAW_SPORT:576,ESST_AC3:577,DRM:9,DTS2:8193,MPEG:80},v={[_.PCM]:`PCM`,[_.ADPCM]:`ADPCM`,[_.IEEE_FLOAT]:`IEEE_FLOAT`,[_.MPEG_ADTS_AAC]:`MPEG_ADTS_AAC`,[_.MPEG_LOAS]:`MPEG_LOAS`,[_.RAW_AAC1]:`RAW_AAC1`,[_.DOLBY_AC3_SPDIF]:`DOLBY_AC3_SPDIF`,[_.DVM]:`DVM`,[_.RAW_SPORT]:`RAW_SPORT`,[_.ESST_AC3]:`ESST_AC3`,[_.DRM]:`DRM`,[_.DTS2]:`DTS2`,[_.MPEG]:`MPEG`};var y=class{constructor(e){if(e.chunkSize<16)throw new g(`Invalid chunk size`);this.len=e.chunkSize}get(e,n){return{wFormatTag:s.get(e,n),nChannels:s.get(e,n+2),nSamplesPerSec:t.get(e,n+4),nAvgBytesPerSec:t.get(e,n+8),nBlockAlign:s.get(e,n+12),wBitsPerSample:s.get(e,n+14)}}},b=class{constructor(e){if(e.chunkSize<4)throw new g(`Invalid fact chunk size.`);this.len=e.chunkSize}get(e,n){return{dwSampleLength:t.get(e,n)}}};const x={len:420,get:(e,i)=>({description:u(new r(256,`ascii`).get(e,i)).trim(),originator:u(new r(32,`ascii`).get(e,i+256)).trim(),originatorReference:u(new r(32,`ascii`).get(e,i+288)).trim(),originationDate:u(new r(10,`ascii`).get(e,i+320)).trim(),originationTime:u(new r(8,`ascii`).get(e,i+330)).trim(),timeReferenceLow:t.get(e,i+338),timeReferenceHigh:t.get(e,i+342),version:s.get(e,i+346),umid:new n(64).get(e,i+348),loudnessValue:s.get(e,i+412),maxTruePeakLevel:s.get(e,i+414),maxMomentaryLoudness:s.get(e,i+416),maxShortTermLoudness:s.get(e,i+418)})};var S=(0,p.default)(`music-metadata:parser:RIFF`),C=class extends o{constructor(){super(...arguments),this.blockAlign=0}async parse(){let e=await this.tokenizer.readToken(m);if(S(`pos=${this.tokenizer.position}, parse: chunkID=${e.chunkID}`),e.chunkID===`RIFF`)return this.metadata.setAudioOnly(),this.parseRiffChunk(e.chunkSize).catch(e=>{if(!(e instanceof c))throw e})}async parseRiffChunk(e){let t=await this.tokenizer.readToken(d);switch(this.metadata.setFormat(`container`,t),t){case`WAVE`:return this.readWaveChunk(e-d.len);default:throw new g(`Unsupported RIFF format: RIFF/${t}`)}}async readWaveChunk(e){for(;e>=m.len;){let t=await this.tokenizer.readToken(m);switch(e-=m.len+t.chunkSize,t.chunkSize>e&&this.metadata.addWarning(`Data chunk size exceeds file size`),this.header=t,S(`pos=${this.tokenizer.position}, readChunk: chunkID=RIFF/WAVE/${t.chunkID}`),t.chunkID){case`LIST`:await this.parseListTag(t);break;case`fact`:this.metadata.setFormat(`lossless`,!1),this.fact=await this.tokenizer.readToken(new b(t));break;case`fmt `:{let e=await this.tokenizer.readToken(new y(t)),n=v[e.wFormatTag];n||=(S(`WAVE/non-PCM format=${e.wFormatTag}`),`non-PCM (${e.wFormatTag})`),this.metadata.setFormat(`codec`,n),this.metadata.setFormat(`bitsPerSample`,e.wBitsPerSample),this.metadata.setFormat(`sampleRate`,e.nSamplesPerSec),this.metadata.setFormat(`numberOfChannels`,e.nChannels),this.metadata.setFormat(`bitrate`,e.nBlockAlign*e.nSamplesPerSec*8),this.blockAlign=e.nBlockAlign;break}case`id3 `:case`ID3 `:{let e=l(await this.tokenizer.readToken(new n(t.chunkSize)));await new f().parse(this.metadata,e,this.options);break}case`data`:{this.metadata.format.lossless!==!1&&this.metadata.setFormat(`lossless`,!0);let e=t.chunkSize;if(this.tokenizer.fileInfo.size){let t=this.tokenizer.fileInfo.size-this.tokenizer.position;t<e&&(this.metadata.addWarning(`data chunk length exceeding file length`),e=t)}let n=this.fact?this.fact.dwSampleLength:e===4294967295?void 0:e/this.blockAlign;n&&(this.metadata.setFormat(`numberOfSamples`,n),this.metadata.format.sampleRate&&this.metadata.setFormat(`duration`,n/this.metadata.format.sampleRate)),this.metadata.format.codec===`ADPCM`?this.metadata.setFormat(`bitrate`,352e3):this.metadata.format.sampleRate&&this.metadata.setFormat(`bitrate`,this.blockAlign*this.metadata.format.sampleRate*8),await this.tokenizer.ignore(t.chunkSize);break}case`bext`:{let e=await this.tokenizer.readToken(x);Object.keys(e).forEach(t=>{this.metadata.addTag(`exif`,`bext.${t}`,e[t])});let n=t.chunkSize-x.len;await this.tokenizer.ignore(n);break}case`\0\0\0\0`:S(`Ignore padding chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),await this.tokenizer.ignore(t.chunkSize);break;default:S(`Ignore chunk: RIFF/${t.chunkID} of ${t.chunkSize} bytes`),this.metadata.addWarning(`Ignore chunk: RIFF/${t.chunkID}`),await this.tokenizer.ignore(t.chunkSize)}this.header.chunkSize%2==1&&(S(`Read odd padding byte`),await this.tokenizer.ignore(1))}}async parseListTag(e){let t=await this.tokenizer.readToken(new r(4,`latin1`));switch(S(`pos=%s, parseListTag: chunkID=RIFF/WAVE/LIST/%s`,this.tokenizer.position,t),t){case`INFO`:return this.parseRiffInfoTags(e.chunkSize-4);default:return this.metadata.addWarning(`Ignore chunk: RIFF/WAVE/LIST/${t}`),S(`Ignoring chunkID=RIFF/WAVE/LIST/${t}`),this.tokenizer.ignore(e.chunkSize-4).then()}}async parseRiffInfoTags(e){for(;e>=8;){let t=await this.tokenizer.readToken(m),n=new h(t),r=await this.tokenizer.readToken(n);this.addTag(t.chunkID,u(r)),e-=8+n.len}if(e!==0)throw new g(`Illegal remaining size: ${e}`)}addTag(e,t){this.metadata.addTag(`exif`,e,t)}};export{C as WaveParser};