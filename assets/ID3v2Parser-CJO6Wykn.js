import{X as e}from"./index-DxXLmhjs.js";import{D as t,E as n,S as r,b as i,k as a,o,s}from"./BasicParser-7vZQ25UN.js";import{a as c,i as l,n as u,r as d}from"./Util-CSdKFQBa.js";import{a as f,l as p,n as m,o as h,r as g,s as _,t as v}from"./ID3v2Token-BAmYJ4Xc.js";import{t as y}from"./ID3v1Parser-BmyMj_Te.js";var b=(0,e(s(),1).default)(`music-metadata:id3v2:frame-parser`),x=`latin1`,S={encoding:x,bom:!1};function C(e){let t=[],n,r=``;for(let i of e)if(typeof n==`string`)if(i===`(`&&n===``)r+=`(`,n=void 0;else if(i===`)`){r!==``&&(t.push(r),r=``);let e=w(n);e&&t.push(e),n=void 0}else n+=i;else i===`(`?n=``:r+=i;return r&&(t.length===0&&r.match(/^\d*$/)&&(r=w(r)),r&&t.push(r)),t}function w(e){if(e===`RX`)return`Remix`;if(e===`CR`)return`Cover`;if(e.match(/^\d*$/))return y[Number.parseInt(e,10)]}var T=class e{constructor(e,t){this.major=e,this.warningCollector=t}readData(t,i,a){if(t.length===0){this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${i}`);return}let{encoding:o,bom:s}=h.get(t,0),c=t.length,p=0,m=[],g=e.getNullTerminatorLength(o),y;switch(b(`Parsing tag type=${i}, encoding=${o}, bom=${s}`),i!==`TXXX`&&i[0]===`T`?`T*`:i){case`T*`:case`GRP1`:case`IPLS`:case`MVIN`:case`MVNM`:case`PCS`:case`PCST`:{let n;try{n=e.trimNullPadding(u(t.subarray(1),o))}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${i} header has invalid string value: ${e.message}`);break}throw e}switch(i){case`TMCL`:case`TIPL`:case`IPLS`:m=e.functionList(this.splitValue(i,n));break;case`TRK`:case`TRCK`:case`TPOS`:m=n;break;case`TCOM`:case`TEXT`:case`TOLY`:case`TOPE`:case`TPE1`:case`TSRC`:m=this.splitValue(i,n);break;case`TCO`:case`TCON`:m=this.splitValue(i,n).map(e=>C(e)).reduce((e,t)=>e.concat(t),[]);break;case`PCS`:case`PCST`:m=this.major>=4?this.splitValue(i,n):[n],m=Array.isArray(m)&&m[0]===``?1:0;break;default:m=this.major>=4?this.splitValue(i,n):[n]}break}case`TXXX`:{let n=e.readIdentifierAndData(t.subarray(1),o);m={description:n.id,text:this.splitValue(i,u(n.data,o).replace(/\x00+$/,``))};break}case`PIC`:case`APIC`:if(a){let n={};switch(t=t.subarray(1),this.major){case 2:n.format=u(t.subarray(0,3),`latin1`),t=t.subarray(3);break;case 3:case 4:y=l(t,x),n.format=u(t.subarray(0,y),x),t=t.subarray(y+1);break;default:throw D(this.major)}n.format=e.fixPictureMimeType(n.format),n.type=v[t[0]],t=t.subarray(1),y=l(t,o),n.description=u(t.subarray(0,y),o),t=t.subarray(y+g),n.data=t,m=n}break;case`CNT`:case`PCNT`:m=d(t);break;case`SYLT`:{let n=f.get(t,0);t=t.subarray(f.len);let i={descriptor:``,language:n.language,contentType:n.contentType,timeStampFormat:n.timeStampFormat,syncText:[]},a=!1;for(;t.length>0;){let o=e.readNullTerminatedString(t,n.encoding);if(t=t.subarray(o.len),a){let e=r.get(t,0);t=t.subarray(r.len),i.syncText.push({text:o.text,timestamp:e})}else i.descriptor=o.text,a=!0}m=i;break}case`ULT`:case`USLT`:case`COM`:case`COMM`:{let n=_.get(t,p);p+=_.len;let r=e.readNullTerminatedString(t.subarray(p),n.encoding);p+=r.len;let i=e.readNullTerminatedString(t.subarray(p),n.encoding);m={language:n.language,descriptor:r.text,text:i.text};break}case`UFID`:{let n=e.readIdentifierAndData(t,x);m={owner_identifier:n.id,identifier:n.data};break}case`PRIV`:{let n=e.readIdentifierAndData(t,x);m={owner_identifier:n.id,data:n.data};break}case`POPM`:{t=t.subarray(p);let r=e.readNullTerminatedString(t,S),a=r.text;if(t=t.subarray(r.len),t.length===0){this.warningCollector.addWarning(`id3v2.${this.major} type=${i} POPM frame missing rating byte`),m={email:a,rating:0,counter:void 0};break}let o=n.get(t,0),s=t.subarray(n.len);m={email:a,rating:o,counter:s.length>0?d(s):void 0};break}case`GEOB`:{let{encoding:n,bom:r}=h.get(t,0);t=t.subarray(1);let i=e.readNullTerminatedString(t,S),a=i.text;t=t.subarray(i.len);let o=e.readNullTerminatedString(t,{encoding:n,bom:r}),s=o.text;t=t.subarray(o.len);let c=e.readNullTerminatedString(t,{encoding:n,bom:r}),l=c.text;t=t.subarray(c.len),m={type:a,filename:s,description:l,data:t};break}case`WCOM`:case`WCOP`:case`WOAF`:case`WOAR`:case`WOAS`:case`WORS`:case`WPAY`:case`WPUB`:m=e.readNullTerminatedString(t,S).text;break;case`WXXX`:{let{encoding:n,bom:r}=h.get(t,0);t=t.subarray(1);let i=e.readNullTerminatedString(t,{encoding:n,bom:r}),a=i.text;t=t.subarray(i.len),m={description:a,url:e.trimNullPadding(u(t,x))};break}case`WFD`:case`WFED`:{let{encoding:n,bom:r}=h.get(t,0);t=t.subarray(1),m=e.readNullTerminatedString(t,{encoding:n,bom:r}).text;break}case`MCDI`:m=t.subarray(0,c);break;default:b(`Warning: unsupported id3v2-tag-type: ${i}`);break}return m}static readNullTerminatedString(t,n){let r=n.bom?2:0,i=t.length,a=t.subarray(r),o=l(a,n.encoding);return o>=a.length?{text:u(a,n.encoding),len:i}:{text:u(a.subarray(0,o),n.encoding),len:r+o+e.getNullTerminatorLength(n.encoding)}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase(),e){case`jpg`:return`image/jpeg`;case`png`:return`image/png`}return e}static functionList(e){let t={};for(let n=0;n+1<e.length;n+=2){let r=e[n+1].split(`,`);t[e[n]]=t[e[n]]?t[e[n]].concat(r):r}return t}splitValue(t,n){let r;return this.major<4?(r=n.split(/\x00/g),r.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${t} uses non standard null-separator.`):r=n.split(/\//g)):r=n.split(/\x00/g),e.trimArray(r)}static trimArray(t){return t.map(t=>e.trimNullPadding(t).trim())}static trimNullPadding(e){let t=e.length;for(;t>0&&e.charCodeAt(t-1)===0;)t--;return t===e.length?e:e.slice(0,t)}static readIdentifierAndData(t,n){let r=e.readNullTerminatedString(t,{encoding:n,bom:!1});return{id:r.text,data:t.subarray(r.len)}}static getNullTerminatorLength(e){return e.startsWith(`utf-16`)?2:1}},E=class extends o(`id3v2`){};function D(e){throw new E(`Unexpected majorVer: ${e}`)}function O(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw N(e)}}function k(e){return{status:{tag_alter_preservation:c(e,0,6),file_alter_preservation:c(e,0,5),read_only:c(e,0,4)},format:{grouping_identity:c(e,1,7),compression:c(e,1,3),encryption:c(e,1,2),unsynchronisation:c(e,1,1),data_length_indicator:c(e,1,0)}}}function A(e,t,n){switch(t){case 2:return j(e,t,n);case 3:case 4:return M(e,t,n);default:throw N(t)}}function j(e,t,n){let r={id:a(e.subarray(0,3),`ascii`),length:i.get(e,3)};return r.id.match(/^[A-Z0-9]{3}$/)||n.addWarning(`Invalid ID3v2.${t} frame-header-ID: ${r.id}`),r}function M(e,t,n){let i={id:a(e.subarray(0,4),`ascii`),length:(t===4?p:r).get(e,4),flags:k(e.subarray(8,10))};return i.id.match(/^[A-Z0-9]{4}$/)||n.addWarning(`Invalid ID3v2.${t} frame-header-ID: ${i.id}`),i}function N(e){throw new E(`Unexpected majorVer: ${e}`)}var P=class e{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,n=0;for(;t<e.length-1;)t!==n&&(e[n]=e[t]),t+=e[t]===255&&e[t+1]===0?2:1,n++;return t<e.length&&(e[n++]=e[t]),e.subarray(0,n)}static readFrameData(t,n,r,i,a){let o=new T(r,a);switch(r){case 2:return o.readData(t,n.id,i);case 3:case 4:return n.flags?.format.unsynchronisation&&(t=e.removeUnsyncBytes(t)),n.flags?.format.data_length_indicator&&(t=t.subarray(4,t.length)),o.readData(t,n.id,i);default:throw F(r)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:``)}async parse(e,t,n){this.tokenizer=t,this.metadata=e,this.options=n;let r=await this.tokenizer.readToken(g);if(r.fileIdentifier!==`ID3`)throw new E(`expected ID3-header file-identifier 'ID3' was not found`);return this.id3Header=r,this.headerType=`ID3v2.${r.version.major}`,r.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(r.size)}async parseExtendedHeader(){let e=await this.tokenizer.readToken(m),t=e.size-m.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){let n=await this.tokenizer.readToken(new t(e));for(let e of this.parseMetadata(n))switch(e.id){case`TXXX`:e.value&&await this.handleTag(e,e.value.text,()=>e.value.description);break;default:await(Array.isArray(e.value)?Promise.all(e.value.map(t=>this.addTag(e.id,t))):this.addTag(e.id,e.value))}}async handleTag(t,n,r,i=e=>e){await Promise.all(n.map(n=>this.addTag(e.makeDescriptionTagName(t.id,r(n)),i(n))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(t){let n=0,r=[];for(;n!==t.length;){let i=O(this.id3Header.version.major);if(n+i>t.length){this.metadata.addWarning(`Illegal ID3v2 tag length`);break}let a=t.subarray(n,n+i);n+=i;let o=A(a,this.id3Header.version.major,this.metadata),s=t.subarray(n,n+o.length);n+=o.length;let c=e.readFrameData(s,o,this.id3Header.version.major,!this.options.skipCovers,this.metadata);c&&r.push({id:o.id,value:c})}return r}};function F(e){throw new E(`Unexpected majorVer: ${e}`)}export{P as t};