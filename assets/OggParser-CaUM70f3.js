import{mt as e}from"./index-wgkUl21K.js";import{C as t,D as n,E as r,T as i,_ as a,b as o,o as s,p as c,s as l,t as u,v as d,y as f}from"./BasicParser-Bl8dDEcI.js";import{i as p}from"./core-BwrZC3T8.js";import{a as m,u as h}from"./Util-QywJh2JX.js";import"./ID3v2Token-CkmP3xq7.js";import{i as g}from"./APEv2Parser-DAtm3-Hw.js";import"./ID3v1Parser-RrYP_beh.js";import"./ID3v2Parser-4UVYZtnl.js";import"./AbstractID3Parser-CCrnKyep.js";import{a as _,i as v,n as y,o as b,r as x,t as S}from"./FlacParser-C428RR1e.js";var C=e(l(),1),w=class extends s(`Opus`){},T=class{constructor(e){if(e<19)throw new w(`ID-header-page 0 should be at least 19 bytes long`);this.len=e}get(e,n){return{magicSignature:new a(8,`ascii`).get(e,n+0),version:r.get(e,n+8),channelCount:r.get(e,n+9),preSkip:f.get(e,n+10),inputSampleRate:t.get(e,n+12),outputGain:f.get(e,n+16),channelMapping:r.get(e,n+18)}}},E=class extends _{constructor(e,t,n){super(e,t),this.idHeader=null,this.lastPos=-1,this.tokenizer=n,this.durationOnLastPage=!0}parseFirstPage(e,t){if(this.metadata.setFormat(`codec`,`Opus`),this.idHeader=new T(t.length).get(t,0),this.idHeader.magicSignature!==`OpusHead`)throw new w(`Illegal ogg/Opus magic-signature`);this.metadata.setFormat(`sampleRate`,this.idHeader.inputSampleRate),this.metadata.setFormat(`numberOfChannels`,this.idHeader.channelCount),this.metadata.setAudioOnly()}async parseFullPage(e){switch(new a(8,`ascii`).get(e,0)){case`OpusTags`:await this.parseUserCommentList(e,8),this.lastPos=this.tokenizer.position-e.length;break;default:break}}calculateDuration(e){if(this.lastPageHeader&&(e||this.lastPageHeader.headerType.lastPage)&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0){let e=this.lastPageHeader.absoluteGranulePosition-this.idHeader.preSkip;if(this.metadata.setFormat(`numberOfSamples`,e),this.metadata.setFormat(`duration`,e/48e3),this.lastPos!==-1&&this.tokenizer.fileInfo.size&&this.metadata.format.duration){let e=this.tokenizer.fileInfo.size-this.lastPos;this.metadata.setFormat(`bitrate`,8*e/this.metadata.format.duration)}}}};const D={len:80,get:(e,t)=>({speex:new a(8,`ascii`).get(e,t+0),version:h(new a(20,`ascii`).get(e,t+8)),version_id:c.get(e,t+28),header_size:c.get(e,t+32),rate:c.get(e,t+36),mode:c.get(e,t+40),mode_bitstream_version:c.get(e,t+44),nb_channels:c.get(e,t+48),bitrate:c.get(e,t+52),frame_size:c.get(e,t+56),vbr:c.get(e,t+60),frames_per_packet:c.get(e,t+64),extra_headers:c.get(e,t+68),reserved1:c.get(e,t+72),reserved2:c.get(e,t+76)})};var O=(0,C.default)(`music-metadata:parser:ogg:speex`),k=class extends _{constructor(e,t,n){super(e,t)}parseFirstPage(e,t){O(`First Ogg/Speex page`);let n=D.get(t,0);this.metadata.setFormat(`codec`,`Speex ${n.version}`),this.metadata.setFormat(`numberOfChannels`,n.nb_channels),this.metadata.setFormat(`sampleRate`,n.rate),n.bitrate!==-1&&this.metadata.setFormat(`bitrate`,n.bitrate),this.metadata.setAudioOnly()}};const A={len:42,get:(e,t)=>({id:new a(7,`ascii`).get(e,t),vmaj:r.get(e,t+7),vmin:r.get(e,t+8),vrev:r.get(e,t+9),vmbw:d.get(e,t+10),vmbh:d.get(e,t+17),nombr:o.get(e,t+37),nqual:r.get(e,t+40)})};var j=(0,e(l(),1).default)(`music-metadata:parser:ogg:theora`),M=class{constructor(e,t,n){this.durationOnLastPage=!1,this.metadata=e}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){j(`duration calculation not implemented`)}async parseFirstPage(e,t){j(`First Ogg/Theora page`),this.metadata.setFormat(`codec`,`Theora`);let n=A.get(t,0);this.metadata.setFormat(`bitrate`,n.nombr),this.metadata.setFormat(`hasVideo`,!0)}flush(){return Promise.resolve()}};const N={len:27,get:(e,n)=>({capturePattern:new a(4,`latin1`).get(e,n),version:r.get(e,n+4),headerType:{continued:m(e,n+5,0),firstPage:m(e,n+5,1),lastPage:m(e,n+5,2)},absoluteGranulePosition:Number(i.get(e,n+6)),streamSerialNumber:t.get(e,n+14),pageSequenceNo:t.get(e,n+18),pageChecksum:t.get(e,n+22),page_segments:r.get(e,n+26)})};var P=class e{static sum(e,t,n){let r=new DataView(e.buffer,0),i=0;for(let e=t;e<t+n;++e)i+=r.getUint8(e);return i}constructor(e){this.len=e.page_segments}get(t,n){return{totalPageSize:e.sum(t,n,this.len)}}},F=(0,e(l(),1).default)(`music-metadata:parser:ogg:theora`),I=class{constructor(e,t,n){this.durationOnLastPage=!1,this.metadata=e,this.options=t,this.tokenizer=n,this.flacParser=new S(this.metadata,this.tokenizer,t)}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){F(`duration calculation not implemented`)}async parseFirstPage(e,t){if(F(`First Ogg/FLAC page`),(await g.get(t,9)).toString()!==`fLaC`)throw Error(`Invalid FLAC preamble`);let n=await y.get(t,13);await this.parseDataBlock(n,t.subarray(13+y.len))}async parseDataBlock(e,t){switch(F(`blockHeader type=${e.type}, length=${e.length}`),e.type){case v.STREAMINFO:{let e=x.get(t,0);return this.flacParser.processsStreamInfo(e)}case v.PADDING:break;case v.APPLICATION:break;case v.SEEKTABLE:break;case v.VORBIS_COMMENT:return this.flacParser.parseComment(t);case v.PICTURE:if(!this.options.skipCovers){let e=new b(t.length).get(t,0);return this.flacParser.addPictureTag(e)}break;default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}flush(){return Promise.resolve()}},L=e(l(),1),R=class extends s(`Ogg`){},z=(0,L.default)(`music-metadata:parser:ogg`),B=class{constructor(e,t,n){this.pageNumber=0,this.closed=!1,this.metadata=e,this.streamSerial=t,this.options=n}async parsePage(e,t){this.pageNumber=t.pageSequenceNo,z(`serial=%s page#=%s, Ogg.id=%s`,t.streamSerialNumber,t.pageSequenceNo,t.capturePattern);let r=await e.readToken(new P(t));z(`totalPageSize=%s`,r.totalPageSize);let i=await e.readToken(new n(r.totalPageSize));if(z(`firstPage=%s, lastPage=%s, continued=%s`,t.headerType.firstPage,t.headerType.lastPage,t.headerType.continued),t.headerType.firstPage){this.metadata.setFormat(`container`,`Ogg`);let n=i.subarray(0,7),r=Array.from(n).filter(e=>e>=32&&e<=126).map(e=>String.fromCharCode(e)).join(``);switch(r){case`vorbis`:z(`Set Ogg stream serial ${t.streamSerialNumber}, codec=Vorbis`),this.pageConsumer=new _(this.metadata,this.options);break;case`OpusHea`:z(`Set page consumer to Ogg/Opus`),this.pageConsumer=new E(this.metadata,this.options,e);break;case`Speex  `:z(`Set page consumer to Ogg/Speex`),this.pageConsumer=new k(this.metadata,this.options,e);break;case`fishead`:case`theora`:z(`Set page consumer to Ogg/Theora`),this.pageConsumer=new M(this.metadata,this.options,e);break;case`FLAC`:z(`Set page consumer to Vorbis`),this.pageConsumer=new I(this.metadata,this.options,e);break;default:throw new R(`Ogg codec not recognized (id=${r}`)}}if(t.headerType.lastPage&&(this.closed=!0),this.pageConsumer)await this.pageConsumer.parsePage(t,i);else throw Error(`pageConsumer should be initialized`)}},V=class extends u{constructor(){super(...arguments),this.streams=new Map}async parse(){this.streams=new Map;let e=!1,t;try{do{if(t=await this.tokenizer.readToken(N),t.capturePattern!==`OggS`)throw new R(`Invalid Ogg capture pattern`);let e=this.streams.get(t.streamSerialNumber);if(e||(e=new B(this.metadata,t.streamSerialNumber,this.options),this.streams.set(t.streamSerialNumber,e)),await e.parsePage(this.tokenizer,t),e.pageNumber>12&&!(this.options.duration&&[...this.streams.values()].find(e=>e.pageConsumer?.durationOnLastPage))){z(`Stop processing Ogg stream`);break}}while(![...this.streams.values()].every(e=>e.closed))}catch(t){if(t instanceof p)z(`Reached end-of-stream`),e=!0;else if(t instanceof R)this.metadata.addWarning(`Corrupt Ogg content at ${this.tokenizer.position}`);else throw t}for(let t of this.streams.values())t.closed||(this.metadata.addWarning(`End-of-stream reached before reaching last page in Ogg stream serial=${t.streamSerial}`),await t.pageConsumer?.flush()),t.pageConsumer?.calculateDuration(e)}};export{V as OggParser};