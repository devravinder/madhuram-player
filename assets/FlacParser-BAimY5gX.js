import{at as e}from"./index-CKI6ZsrI.js";import{C as t,D as n,E as r,S as i,_ as a,b as o,k as s,o as c,s as l,v as u}from"./BasicParser-Bu3H9Iz_.js";import{a as d,o as f}from"./Util-DAtXxaTN.js";import{t as p}from"./ID3v2Token-BGPm03gz.js";import{i as m}from"./APEv2Parser-BNbN51mP.js";import{t as h}from"./AbstractID3Parser-C17gmtP_.js";var g=class e{static fromBase64(t){return e.fromBuffer(Uint8Array.from(atob(t),e=>e.charCodeAt(0)))}static fromBuffer(t){return new e(t.length).get(t,0)}constructor(e){this.len=e}get(e,t){let n=p[i.get(e,t)];t+=4;let r=i.get(e,t);t+=4;let o=new a(r,`utf-8`).get(e,t);t+=r;let s=i.get(e,t);t+=4;let c=new a(s,`utf-8`).get(e,t);t+=s;let l=i.get(e,t);t+=4;let u=i.get(e,t);t+=4;let d=i.get(e,t);t+=4;let f=i.get(e,t);t+=4;let m=i.get(e,t);return t+=4,{type:n,format:o,description:c,width:l,height:u,colour_depth:d,indexed_color:f,data:e.slice(t,t+m)}}};const _={len:7,get:(e,t)=>({packetType:r.get(e,t),vorbis:new a(6,`ascii`).get(e,t+1)})},v={len:23,get:(e,n)=>({version:t.get(e,n+0),channelMode:r.get(e,n+4),sampleRate:t.get(e,n+5),bitrateMax:t.get(e,n+9),bitrateNominal:t.get(e,n+13),bitrateMin:t.get(e,n+17)})};var y=class{constructor(e,t){this.data=e,this.offset=t}readInt32(){let e=t.get(this.data,this.offset);return this.offset+=4,e}readStringUtf8(){let e=this.readInt32(),t=s(this.data.subarray(this.offset,this.offset+e),`utf-8`);return this.offset+=e,t}parseUserComment(){let e=this.offset,t=this.readStringUtf8(),n=t.indexOf(`=`);return{key:t.substring(0,n).toUpperCase(),value:t.substring(n+1),len:this.offset-e}}},b=(0,e(l(),1).default)(`music-metadata:parser:ogg:vorbis1`),x=class extends c(`Vorbis`){},S=class e{constructor(e,t){this.pageSegments=[],this.durationOnLastPage=!0,this.metadata=e,this.options=t}async parsePage(t,n){if(this.lastPageHeader=t,t.headerType.firstPage)this.parseFirstPage(t,n);else{if(t.headerType.continued){if(this.pageSegments.length===0)throw new x(`Cannot continue on previous page`);this.pageSegments.push(n)}if(t.headerType.lastPage||!t.headerType.continued){if(this.pageSegments.length>0){let t=e.mergeUint8Arrays(this.pageSegments);await this.parseFullPage(t)}this.pageSegments=t.headerType.lastPage?[]:[n]}}}static mergeUint8Arrays(e){let t=e.reduce((e,t)=>e+t.length,0),n=new Uint8Array(t);return e.forEach((e,t,r)=>{let i=r.slice(0,t).reduce((e,t)=>e+t.length,0);n.set(e,i)}),n}async flush(){await this.parseFullPage(e.mergeUint8Arrays(this.pageSegments))}async parseUserComment(e,t){let n=new y(e,t).parseUserComment();return await this.addTag(n.key,n.value),n.len}async addTag(e,t){if(e===`METADATA_BLOCK_PICTURE`&&typeof t==`string`){if(this.options.skipCovers){b(`Ignore picture`);return}t=g.fromBase64(t),b(`Push picture: id=${e}, format=${t.format}`)}else b(`Push tag: id=${e}, value=${t}`);await this.metadata.addTag(`vorbis`,e,t)}calculateDuration(e){this.lastPageHeader&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0&&(this.metadata.setFormat(`numberOfSamples`,this.lastPageHeader.absoluteGranulePosition),this.metadata.setFormat(`duration`,this.lastPageHeader.absoluteGranulePosition/this.metadata.format.sampleRate))}parseFirstPage(e,t){this.metadata.setFormat(`codec`,`Vorbis I`),this.metadata.setFormat(`hasAudio`,!0),b(`Parse first page`);let n=_.get(t,0);if(n.vorbis!==`vorbis`)throw new x(`Metadata does not look like Vorbis`);if(n.packetType===1){let e=v.get(t,_.len);this.metadata.setFormat(`sampleRate`,e.sampleRate),this.metadata.setFormat(`bitrate`,e.bitrateNominal),this.metadata.setFormat(`numberOfChannels`,e.channelMode),b(`sample-rate=%s[hz], bitrate=%s[b/s], channel-mode=%s`,e.sampleRate,e.bitrateNominal,e.channelMode)}else throw new x(`First Ogg page should be type 1: the identification header`)}async parseFullPage(e){let t=_.get(e,0);switch(b(`Parse full page: type=%s, byteLength=%s`,t.packetType,e.byteLength),t.packetType){case 3:return this.parseUserCommentList(e,_.len);case 1:case 5:break}}async parseUserCommentList(e,n){let r=t.get(e,n);n+=4,n+=r;let i=t.get(e,n);for(n+=4;i-- >0;)n+=await this.parseUserComment(e,n)}};const C={STREAMINFO:0,PADDING:1,APPLICATION:2,SEEKTABLE:3,VORBIS_COMMENT:4,CUESHEET:5,PICTURE:6},w={len:4,get:(e,t)=>({lastBlock:d(e,t,7),type:f(e,t,1,7),length:o.get(e,t+1)})},T={len:34,get:(e,t)=>({minimumBlockSize:u.get(e,t),maximumBlockSize:u.get(e,t+2)/1e3,minimumFrameSize:o.get(e,t+4),maximumFrameSize:o.get(e,t+7),sampleRate:o.get(e,t+10)>>4,channels:f(e,t+12,4,3)+1,bitsPerSample:f(e,t+12,7,5)+1,totalSamples:f(e,t+13,4,36),fileMD5:new n(16).get(e,t+18)})};var E=(0,e(l(),1).default)(`music-metadata:parser:FLAC`),D=class extends c(`FLAC`){},O=class extends h{constructor(){super(...arguments),this.vorbisParser=new S(this.metadata,this.options),this.padding=0}async postId3v2Parse(){if((await this.tokenizer.readToken(m)).toString()!==`fLaC`)throw new D(`Invalid FLAC preamble`);let e;do e=await this.tokenizer.readToken(w),await this.parseDataBlock(e);while(!e.lastBlock);if(this.tokenizer.fileInfo.size&&this.metadata.format.duration){let e=this.tokenizer.fileInfo.size-this.tokenizer.position;this.metadata.setFormat(`bitrate`,8*e/this.metadata.format.duration)}}async parseDataBlock(e){switch(E(`blockHeader type=${e.type}, length=${e.length}`),e.type){case C.STREAMINFO:return this.readBlockStreamInfo(e.length);case C.PADDING:this.padding+=e.length;break;case C.APPLICATION:break;case C.SEEKTABLE:break;case C.VORBIS_COMMENT:return this.readComment(e.length);case C.CUESHEET:break;case C.PICTURE:await this.parsePicture(e.length);return;default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}async readBlockStreamInfo(e){if(e!==T.len)throw new D(`Unexpected block-stream-info length`);let t=await this.tokenizer.readToken(T);this.metadata.setFormat(`container`,`FLAC`),this.processsStreamInfo(t)}processsStreamInfo(e){this.metadata.setFormat(`codec`,`FLAC`),this.metadata.setFormat(`hasAudio`,!0),this.metadata.setFormat(`lossless`,!0),this.metadata.setFormat(`numberOfChannels`,e.channels),this.metadata.setFormat(`bitsPerSample`,e.bitsPerSample),this.metadata.setFormat(`sampleRate`,e.sampleRate),e.totalSamples>0&&this.metadata.setFormat(`duration`,e.totalSamples/e.sampleRate)}async readComment(e){let t=await this.tokenizer.readToken(new n(e));return this.parseComment(t)}async parseComment(e){let t=new y(e,0),n=t.readStringUtf8();n.length>0&&this.metadata.setFormat(`tool`,n);let r=t.readInt32(),i=Array(r);for(let e=0;e<r;e++)i[e]=t.parseUserComment();await Promise.all(i.map(e=>(e.key===`ENCODER`&&this.metadata.setFormat(`tool`,e.value),this.addTag(e.key,e.value))))}async parsePicture(e){return this.options.skipCovers?this.tokenizer.ignore(e):this.addPictureTag(await this.tokenizer.readToken(new g(e)))}addPictureTag(e){return this.addTag(`METADATA_BLOCK_PICTURE`,e)}addTag(e,t){return this.vorbisParser.addTag(e,t)}};export{S as a,C as i,w as n,g as o,T as r,O as t};