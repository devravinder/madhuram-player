import{dt as e}from"./index-DzUtD4Ki.js";import{C as t,D as n,E as r,o as i,s as a,t as o,x as s,y as c}from"./BasicParser-C31eTsyU.js";import"./core-SrxPbndD.js";import{p as l}from"./Util-9vMxC6eI.js";import{i as u,r as d}from"./APEv2Parser-CMA1aD3d.js";var f=[6e3,8e3,9600,11025,12e3,16e3,22050,24e3,32e3,44100,48e3,64e3,88200,96e3,192e3,-1];const p={len:32,get:(e,r)=>{let i=t.get(e,r+24),a={BlockID:u.get(e,r),blockSize:t.get(e,r+4),version:c.get(e,r+8),totalSamples:t.get(e,r+12),blockIndex:t.get(e,r+16),blockSamples:t.get(e,r+20),flags:{bitsPerSample:(1+g(i,0,2))*8,isMono:h(i,2),isHybrid:h(i,3),isJointStereo:h(i,4),crossChannel:h(i,5),hybridNoiseShaping:h(i,6),floatingPoint:h(i,7),samplingRate:f[g(i,23,4)],isDSD:h(i,31)},crc:new n(4).get(e,r+28)};return a.flags.isDSD&&(a.totalSamples*=8),a}},m={len:1,get:(e,t)=>({functionId:g(e[t],0,6),isOptional:h(e[t],5),isOddSize:h(e[t],6),largeBlock:h(e[t],7)})};function h(e,t){return g(e,t,1)===1}function g(e,t,n){return e>>>t&4294967295>>>32-n}var _=(0,e(a(),1).default)(`music-metadata:parser:WavPack`),v=class extends i(`WavPack`){},y=class extends o{constructor(){super(...arguments),this.audioDataSize=0}async parse(){return this.metadata.setAudioOnly(),this.audioDataSize=0,await this.parseWavPackBlocks(),d(this.metadata,this.tokenizer,this.options)}async parseWavPackBlocks(){do{if(await this.tokenizer.peekToken(u)!==`wvpk`)break;let e=await this.tokenizer.readToken(p);if(e.BlockID!==`wvpk`)throw new v(`Invalid WavPack Block-ID`);_(`WavPack header blockIndex=${e.blockIndex}, len=${p.len}`),e.blockIndex===0&&!this.metadata.format.container&&(this.metadata.setFormat(`container`,`WavPack`),this.metadata.setFormat(`lossless`,!e.flags.isHybrid),this.metadata.setFormat(`bitsPerSample`,e.flags.bitsPerSample),e.flags.isDSD||(this.metadata.setFormat(`sampleRate`,e.flags.samplingRate),this.metadata.setFormat(`duration`,e.totalSamples/e.flags.samplingRate)),this.metadata.setFormat(`numberOfChannels`,e.flags.isMono?1:2),this.metadata.setFormat(`numberOfSamples`,e.totalSamples),this.metadata.setFormat(`codec`,e.flags.isDSD?`DSD`:`PCM`));let t=e.blockSize-(p.len-8);await(e.blockIndex===0?this.parseMetadataSubBlock(e,t):this.tokenizer.ignore(t)),e.blockSamples>0&&(this.audioDataSize+=e.blockSize)}while(!this.tokenizer.fileInfo.size||this.tokenizer.fileInfo.size-this.tokenizer.position>=p.len);this.metadata.format.duration&&this.metadata.setFormat(`bitrate`,this.audioDataSize*8/this.metadata.format.duration)}async parseMetadataSubBlock(e,t){let n=t;for(;n>m.len;){let t=await this.tokenizer.readToken(m),i=await this.tokenizer.readNumber(t.largeBlock?s:r),a=new Uint8Array(i*2-(t.isOddSize?1:0));switch(await this.tokenizer.readBuffer(a),_(`Metadata Sub-Blocks functionId=0x${t.functionId.toString(16)}, id.largeBlock=${t.largeBlock},data-size=${a.length}`),t.functionId){case 0:break;case 14:{_(`ID_DSD_BLOCK`);let t=1<<r.get(a,0),n=e.flags.samplingRate*t*8;if(!e.flags.isDSD)throw new v(`Only expect DSD block if DSD-flag is set`);this.metadata.setFormat(`sampleRate`,n),this.metadata.setFormat(`duration`,e.totalSamples/n);break}case 36:_(`ID_ALT_TRAILER: trailer for non-wav files`);break;case 38:this.metadata.setFormat(`audioMD5`,a);break;case 47:_(`ID_BLOCK_CHECKSUM: checksum=${l(a)}`);break;default:_(`Ignore unsupported meta-sub-block-id functionId=0x${t.functionId.toString(16)}`);break}n-=m.len+(t.largeBlock?s.len:r.len)+i*2,_(`remainingLength=${n}`),t.isOddSize&&this.tokenizer.ignore(1)}if(n!==0)throw new v(`metadata-sub-block should fit it remaining length`)}};export{y as WavPackParser};