import{at as e}from"./index-CKI6ZsrI.js";import{T as t,h as n,o as r,p as i,s as a}from"./BasicParser-Bu3H9Iz_.js";import"./core-B0hkJOfv.js";import"./Util-DAtXxaTN.js";import"./ID3v2Token-BGPm03gz.js";import{i as o}from"./APEv2Parser-BNbN51mP.js";import"./ID3v1Parser-ZBOvkw8C.js";import{t as s}from"./ID3v2Parser-CaW9OcEf.js";import{t as c}from"./AbstractID3Parser-C17gmtP_.js";var l=e(a(),1);const u={len:12,get:(e,n)=>({id:o.get(e,n),size:t.get(e,n+4)})},d={len:16,get:(e,t)=>({fileSize:n.get(e,t),metadataPointer:n.get(e,t+8)})},f={len:40,get:(e,t)=>({formatVersion:i.get(e,t),formatID:i.get(e,t+4),channelType:i.get(e,t+8),channelNum:i.get(e,t+12),samplingFrequency:i.get(e,t+16),bitsPerSample:i.get(e,t+20),sampleCount:n.get(e,t+24),blockSizePerChannel:i.get(e,t+32)})};var p=(0,l.default)(`music-metadata:parser:DSF`),m=class extends r(`DSD`){},h=class extends c{async postId3v2Parse(){let e=this.tokenizer.position,t=await this.tokenizer.readToken(u);if(t.id!==`DSD `)throw new m(`Invalid chunk signature`);this.metadata.setFormat(`container`,`DSF`),this.metadata.setFormat(`lossless`,!0),this.metadata.setAudioOnly();let n=await this.tokenizer.readToken(d);if(n.metadataPointer===BigInt(0))p(`No ID3v2 tag present`);else return p(`expect ID3v2 at offset=${n.metadataPointer}`),await this.parseChunks(n.fileSize-t.size),await this.tokenizer.ignore(Number(n.metadataPointer)-this.tokenizer.position-e),new s().parse(this.metadata,this.tokenizer,this.options)}async parseChunks(e){for(;e>=u.len;){let t=await this.tokenizer.readToken(u);switch(p(`Parsing chunk name=${t.id} size=${t.size}`),t.id){case`fmt `:{let e=await this.tokenizer.readToken(f);this.metadata.setFormat(`numberOfChannels`,e.channelNum),this.metadata.setFormat(`sampleRate`,e.samplingFrequency),this.metadata.setFormat(`bitsPerSample`,e.bitsPerSample),this.metadata.setFormat(`numberOfSamples`,e.sampleCount),this.metadata.setFormat(`duration`,Number(e.sampleCount)/e.samplingFrequency);let t=e.bitsPerSample*e.samplingFrequency*e.channelNum;this.metadata.setFormat(`bitrate`,t);return}default:this.tokenizer.ignore(Number(t.size)-u.len);break}e-=t.size}}};export{h as DsfParser};