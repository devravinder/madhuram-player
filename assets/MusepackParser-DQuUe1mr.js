import{st as e}from"./index-BLjs2o18.js";import{C as t,E as n,_ as r,k as i,o as a,s as o,t as s,y as c}from"./BasicParser-_YdBDVKJ.js";import"./core-SrxPbndD.js";import{o as l,s as u}from"./Util-650YjRsD.js";import"./ID3v2Token-D9rStPQo.js";import{i as d,r as f}from"./APEv2Parser-BB3KA6i1.js";import"./ID3v1Parser-D73-tQHy.js";import"./ID3v2Parser-BNgf2RC4.js";import{t as p}from"./AbstractID3Parser-ByrmFOVg.js";var m=(0,e(o(),1).default)(`music-metadata:parser:musepack:sv8`),h=new r(2,`latin1`),g={len:5,get:(e,r)=>({crc:t.get(e,r),streamVersion:n.get(e,r+4)})},_={len:2,get:(e,t)=>({sampleFrequency:[44100,48e3,37800,32e3][l(e,t,0,3)],maxUsedBands:l(e,t,3,5),channelCount:l(e,t+1,0,4)+1,msUsed:u(e,t+1,4),audioBlockFrames:l(e,t+1,5,3)})},v=class{get tokenizer(){return this._tokenizer}set tokenizer(e){this._tokenizer=e}constructor(e){this._tokenizer=e}async readPacketHeader(){let e=await this.tokenizer.readToken(h),t=await this.readVariableSizeField();return{key:e,payloadLength:t.value-2-t.len}}async readStreamHeader(e){let t={};m(`Reading SH at offset=${this.tokenizer.position}`);let n=await this.tokenizer.readToken(g);e-=g.len,Object.assign(t,n),m(`SH.streamVersion = ${n.streamVersion}`);let r=await this.readVariableSizeField();e-=r.len,t.sampleCount=r.value;let i=await this.readVariableSizeField();e-=i.len,t.beginningOfSilence=i.value;let a=await this.tokenizer.readToken(_);return e-=_.len,Object.assign(t,a),await this.tokenizer.ignore(e),t}async readVariableSizeField(e=1,t=0){let r=await this.tokenizer.readNumber(n);return r&128?(r&=127,r+=t,this.readVariableSizeField(e+1,r<<7)):{len:e,value:t+r}}},y=class extends a(`Musepack`){},b=(0,e(o(),1).default)(`music-metadata:parser:musepack`),x=class extends s{constructor(){super(...arguments),this.audioLength=0}async parse(){if(await this.tokenizer.readToken(d)!==`MPCK`)throw new y(`Invalid Magic number`);return this.metadata.setFormat(`container`,`Musepack, SV8`),this.parsePacket()}async parsePacket(){let e=new v(this.tokenizer);do{let t=await e.readPacketHeader();switch(b(`packet-header key=${t.key}, payloadLength=${t.payloadLength}`),t.key){case`SH`:{let n=await e.readStreamHeader(t.payloadLength);this.metadata.setFormat(`numberOfSamples`,n.sampleCount),this.metadata.setFormat(`sampleRate`,n.sampleFrequency),this.metadata.setFormat(`duration`,n.sampleCount/n.sampleFrequency),this.metadata.setFormat(`numberOfChannels`,n.channelCount);break}case`AP`:this.audioLength+=t.payloadLength,await this.tokenizer.ignore(t.payloadLength);break;case`RG`:case`EI`:case`SO`:case`ST`:case`CT`:await this.tokenizer.ignore(t.payloadLength);break;case`SE`:return this.metadata.format.duration&&this.metadata.setFormat(`bitrate`,this.audioLength*8/this.metadata.format.duration),f(this.metadata,this.tokenizer,this.options);default:throw new y(`Unexpected header: ${t.key}`)}}while(!0)}},S=class{constructor(e){this.pos=0,this.dword=null,this.tokenizer=e}async read(e){for(;this.dword===null;)this.dword=await this.tokenizer.readToken(t);let n=this.dword;return this.pos+=e,this.pos<32?(n>>>=32-this.pos,n&(1<<e)-1):(this.pos-=32,this.pos===0?(this.dword=null,n&(1<<e)-1):(this.dword=await this.tokenizer.readToken(t),this.pos&&(n<<=this.pos,n|=this.dword>>>32-this.pos),n&(1<<e)-1))}async ignore(e){if(this.pos>0){let t=32-this.pos;this.dword=null,e-=t,this.pos=0}let t=e%32,n=(e-t)/32;return await this.tokenizer.ignore(n*4),this.read(t)}};const C={len:24,get:(e,n)=>{let r={signature:i(e.subarray(n,n+3),`latin1`),streamMinorVersion:l(e,n+3,0,4),streamMajorVersion:l(e,n+3,4,4),frameCount:t.get(e,n+4),maxLevel:c.get(e,n+8),sampleFrequency:[44100,48e3,37800,32e3][l(e,n+10,0,2)],link:l(e,n+10,2,2),profile:l(e,n+10,4,4),maxBand:l(e,n+11,0,6),intensityStereo:u(e,n+11,6),midSideStereo:u(e,n+11,7),titlePeak:c.get(e,n+12),titleGain:c.get(e,n+14),albumPeak:c.get(e,n+16),albumGain:c.get(e,n+18),lastFrameLength:t.get(e,n+20)>>>20&2047,trueGapless:u(e,n+23,0)};return r.lastFrameLength=r.trueGapless?t.get(e,20)>>>20&2047:0,r}};var w=(0,e(o(),1).default)(`music-metadata:parser:musepack`),T=class extends s{constructor(){super(...arguments),this.bitreader=null,this.audioLength=0,this.duration=null}async parse(){let e=await this.tokenizer.readToken(C);if(e.signature!==`MP+`)throw new y(`Unexpected magic number`);w(`stream-version=${e.streamMajorVersion}.${e.streamMinorVersion}`),this.metadata.setFormat(`container`,`Musepack, SV7`),this.metadata.setFormat(`sampleRate`,e.sampleFrequency);let t=1152*(e.frameCount-1)+e.lastFrameLength;this.metadata.setFormat(`numberOfSamples`,t),this.duration=t/e.sampleFrequency,this.metadata.setFormat(`duration`,this.duration),this.bitreader=new S(this.tokenizer),this.metadata.setFormat(`numberOfChannels`,e.midSideStereo||e.intensityStereo?2:1);let n=await this.bitreader.read(8);return this.metadata.setFormat(`codec`,(n/100).toFixed(2)),await this.skipAudioData(e.frameCount),w(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`),f(this.metadata,this.tokenizer,this.options)}async skipAudioData(e){for(;e-- >0;){let e=await this.bitreader.read(20);this.audioLength+=20+e,await this.bitreader.ignore(e)}let t=await this.bitreader.read(11);this.audioLength+=t,this.duration!==null&&this.metadata.setFormat(`bitrate`,this.audioLength/this.duration)}},E=(0,e(o(),1).default)(`music-metadata:parser:musepack`),D=class extends p{async postId3v2Parse(){let e=await this.tokenizer.peekToken(new r(3,`latin1`)),t;switch(e){case`MP+`:E(`Stream-version 7`),t=new T(this.metadata,this.tokenizer,this.options);break;case`MPC`:E(`Stream-version 8`),t=new x(this.metadata,this.tokenizer,this.options);break;default:throw new y(`Invalid signature prefix`)}return this.metadata.setAudioOnly(),t.parse()}};export{D as MusepackParser};