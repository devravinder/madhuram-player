import{at as e}from"./index-DX9fX_me.js";import{C as t,T as n,_ as r,o as i,s as a,t as o,y as s}from"./BasicParser-JjNMHjIZ.js";import{a as c,c as l,f as u,n as d,p as f}from"./Util-C_W9-HJL.js";import{t as p}from"./ID3v2Token-BYCucQet.js";import{n as m}from"./types-BfLy63kP.js";var h=e(a(),1),g=class e{static fromBin(t,n=0){return new e(e.decode(t,n))}static decode(e,t=0){let n=new DataView(e.buffer,t);return`${n.getUint32(0,!0).toString(16)}-${n.getUint16(4,!0).toString(16)}-${n.getUint16(6,!0).toString(16)}-${n.getUint16(8).toString(16)}-${f(e.subarray(t+10,t+16))}`.toUpperCase()}static decodeMediaType(t){switch(t.str){case e.AudioMedia.str:return`audio`;case e.VideoMedia.str:return`video`;case e.CommandMedia.str:return`command`;case e.Degradable_JPEG_Media.str:return`degradable-jpeg`;case e.FileTransferMedia.str:return`file-transfer`;case e.BinaryMedia.str:return`binary`}}static encode(e){let t=new Uint8Array(16),n=new DataView(t.buffer);return n.setUint32(0,Number.parseInt(e.substring(0,8),16),!0),n.setUint16(4,Number.parseInt(e.substring(9,13),16),!0),n.setUint16(6,Number.parseInt(e.substring(14,18),16),!0),t.set(u(e.substring(19,23)),8),t.set(u(e.substring(24)),10),t}constructor(e){this.str=e}equals(e){return this.str===e.str}toBin(){return e.encode(this.str)}};g.HeaderObject=new g(`75B22630-668E-11CF-A6D9-00AA0062CE6C`),g.DataObject=new g(`75B22636-668E-11CF-A6D9-00AA0062CE6C`),g.SimpleIndexObject=new g(`33000890-E5B1-11CF-89F4-00A0C90349CB`),g.IndexObject=new g(`D6E229D3-35DA-11D1-9034-00A0C90349BE`),g.MediaObjectIndexObject=new g(`FEB103F8-12AD-4C64-840F-2A1D2F7AD48C`),g.TimecodeIndexObject=new g(`3CB73FD0-0C4A-4803-953D-EDF7B6228F0C`),g.FilePropertiesObject=new g(`8CABDCA1-A947-11CF-8EE4-00C00C205365`),g.StreamPropertiesObject=new g(`B7DC0791-A9B7-11CF-8EE6-00C00C205365`),g.HeaderExtensionObject=new g(`5FBF03B5-A92E-11CF-8EE3-00C00C205365`),g.CodecListObject=new g(`86D15240-311D-11D0-A3A4-00A0C90348F6`),g.ScriptCommandObject=new g(`1EFB1A30-0B62-11D0-A39B-00A0C90348F6`),g.MarkerObject=new g(`F487CD01-A951-11CF-8EE6-00C00C205365`),g.BitrateMutualExclusionObject=new g(`D6E229DC-35DA-11D1-9034-00A0C90349BE`),g.ErrorCorrectionObject=new g(`75B22635-668E-11CF-A6D9-00AA0062CE6C`),g.ContentDescriptionObject=new g(`75B22633-668E-11CF-A6D9-00AA0062CE6C`),g.ExtendedContentDescriptionObject=new g(`D2D0A440-E307-11D2-97F0-00A0C95EA850`),g.ContentBrandingObject=new g(`2211B3FA-BD23-11D2-B4B7-00A0C955FC6E`),g.StreamBitratePropertiesObject=new g(`7BF875CE-468D-11D1-8D82-006097C9A2B2`),g.ContentEncryptionObject=new g(`2211B3FB-BD23-11D2-B4B7-00A0C955FC6E`),g.ExtendedContentEncryptionObject=new g(`298AE614-2622-4C17-B935-DAE07EE9289C`),g.DigitalSignatureObject=new g(`2211B3FC-BD23-11D2-B4B7-00A0C955FC6E`),g.PaddingObject=new g(`1806D474-CADF-4509-A4BA-9AABCB96AAE8`),g.ExtendedStreamPropertiesObject=new g(`14E6A5CB-C672-4332-8399-A96952065B5A`),g.AdvancedMutualExclusionObject=new g(`A08649CF-4775-4670-8A16-6E35357566CD`),g.GroupMutualExclusionObject=new g(`D1465A40-5A79-4338-B71B-E36B8FD6C249`),g.StreamPrioritizationObject=new g(`D4FED15B-88D3-454F-81F0-ED5C45999E24`),g.BandwidthSharingObject=new g(`A69609E6-517B-11D2-B6AF-00C04FD908E9`),g.LanguageListObject=new g(`7C4346A9-EFE0-4BFC-B229-393EDE415C85`),g.MetadataObject=new g(`C5F8CBEA-5BAF-4877-8467-AA8C44FA4CCA`),g.MetadataLibraryObject=new g(`44231C94-9498-49D1-A141-1D134E457054`),g.IndexParametersObject=new g(`D6E229DF-35DA-11D1-9034-00A0C90349BE`),g.MediaObjectIndexParametersObject=new g(`6B203BAD-3F11-48E4-ACA8-D7613DE2CFA7`),g.TimecodeIndexParametersObject=new g(`F55E496D-9797-4B5D-8C8B-604DFE9BFB24`),g.CompatibilityObject=new g(`26F18B5D-4584-47EC-9F5F-0E651F0452C9`),g.AdvancedContentEncryptionObject=new g(`43058533-6981-49E6-9B74-AD12CB86D58C`),g.AudioMedia=new g(`F8699E40-5B4D-11CF-A8FD-00805F5C442B`),g.VideoMedia=new g(`BC19EFC0-5B4D-11CF-A8FD-00805F5C442B`),g.CommandMedia=new g(`59DACFC0-59E6-11D0-A3AC-00A0C90348F6`),g.JFIF_Media=new g(`B61BE100-5B4E-11CF-A8FD-00805F5C442B`),g.Degradable_JPEG_Media=new g(`35907DE0-E415-11CF-A917-00805F5C442B`),g.FileTransferMedia=new g(`91BD222C-F21C-497A-8B6D-5AA86BFC0185`),g.BinaryMedia=new g(`3AFB65E2-47EF-40F2-AC2C-70A90D71D343`),g.ASF_Index_Placeholder_Object=new g(`D9AADE20-7C17-4F9C-BC28-8555DD98E2A2`);var _=g;function v(e){return b[e]}function y(e){return l(d(e,`utf-16le`))}var b=[y,x,S,C,w,T,x];function x(e){return new Uint8Array(e)}function S(e,t=0){return T(e,t)===1}function C(e,n=0){return t.get(e,n)}function w(e,t=0){return n.get(e,t)}function T(e,t=0){return s.get(e,t)}var E=class extends i(`ASF`){};const D={len:30,get:(e,r)=>({objectId:_.fromBin(e,r),objectSize:Number(n.get(e,r+16)),numberOfHeaderObjects:t.get(e,r+24)})},O={len:24,get:(e,t)=>({objectId:_.fromBin(e,t),objectSize:Number(n.get(e,t+16))})};var k=class{constructor(e){this.len=Number(e.objectSize)-O.len}postProcessTag(e,t,n,r){if(t===`WM/Picture`)e.push({id:t,value:W.fromBuffer(r)});else{let i=v(n);if(!i)throw new E(`unexpected value headerType: ${n}`);e.push({id:t,value:i(r)})}}},A=class extends k{get(e,t){return null}},j=class extends k{get(e,r){return{fileId:_.fromBin(e,r),fileSize:n.get(e,r+16),creationDate:n.get(e,r+24),dataPacketsCount:n.get(e,r+32),playDuration:n.get(e,r+40),sendDuration:n.get(e,r+48),preroll:n.get(e,r+56),flags:{broadcast:c(e,r+64,24),seekable:c(e,r+64,25)},minimumDataPacketSize:t.get(e,r+68),maximumDataPacketSize:t.get(e,r+72),maximumBitrate:t.get(e,r+76)}}};j.guid=_.FilePropertiesObject;var M=class extends k{get(e,t){return{streamType:_.decodeMediaType(_.fromBin(e,t)),errorCorrectionType:_.fromBin(e,t+8)}}};M.guid=_.StreamPropertiesObject;var N=class{constructor(){this.len=22}get(e,t){let n=new DataView(e.buffer,t);return{reserved1:_.fromBin(e,t),reserved2:n.getUint16(16,!0),extensionDataSize:n.getUint16(18,!0)}}};N.guid=_.HeaderExtensionObject;var P={len:20,get:(e,t)=>({entryCount:new DataView(e.buffer,t).getUint16(16,!0)})};async function F(e){let t=await e.readNumber(s);return(await e.readToken(new r(t*2,`utf-16le`))).replace(`\0`,``)}async function I(e){let t=await e.readToken(P),n=[];for(let r=0;r<t.entryCount;++r)n.push(await R(e));return n}async function L(e){let t=await e.readNumber(s),n=new Uint8Array(t);return await e.readBuffer(n),n}async function R(e){let t=await e.readNumber(s);return{type:{videoCodec:(t&1)==1,audioCodec:(t&2)==2},codecName:await F(e),description:await F(e),information:await L(e)}}var z=class e extends k{get(t,n){let r=[],i=new DataView(t.buffer,n),a=10;for(let o=0;o<e.contentDescTags.length;++o){let s=i.getUint16(o*2,!0);if(s>0){let i=e.contentDescTags[o],c=a+s;r.push({id:i,value:y(t.subarray(n+a,n+c))}),a=c}}return r}};z.guid=_.ContentDescriptionObject,z.contentDescTags=[`Title`,`Author`,`Copyright`,`Description`,`Rating`];var B=class extends k{get(e,t){let n=[],r=new DataView(e.buffer,t),i=r.getUint16(0,!0),a=2;for(let o=0;o<i;o+=1){let i=r.getUint16(a,!0);a+=2;let o=y(e.subarray(t+a,t+a+i));a+=i;let s=r.getUint16(a,!0);a+=2;let c=r.getUint16(a,!0);a+=2;let l=e.subarray(t+a,t+a+c);a+=c,this.postProcessTag(n,o,s,l)}return n}};B.guid=_.ExtendedContentDescriptionObject;var V=class extends k{get(e,t){let r=new DataView(e.buffer,t);return{startTime:n.get(e,t),endTime:n.get(e,t+8),dataBitrate:r.getInt32(12,!0),bufferSize:r.getInt32(16,!0),initialBufferFullness:r.getInt32(20,!0),alternateDataBitrate:r.getInt32(24,!0),alternateBufferSize:r.getInt32(28,!0),alternateInitialBufferFullness:r.getInt32(32,!0),maximumObjectSize:r.getInt32(36,!0),flags:{reliableFlag:c(e,t+40,0),seekableFlag:c(e,t+40,1),resendLiveCleanpointsFlag:c(e,t+40,2)},streamNumber:r.getInt16(42,!0),streamLanguageId:r.getInt16(44,!0),averageTimePerFrame:r.getInt32(52,!0),streamNameCount:r.getInt32(54,!0),payloadExtensionSystems:r.getInt32(56,!0),streamNames:[],streamPropertiesObject:null}}};V.guid=_.ExtendedStreamPropertiesObject;var H=class extends k{get(e,t){let n=[],r=new DataView(e.buffer,t),i=r.getUint16(0,!0),a=2;for(let o=0;o<i;o+=1){a+=4;let i=r.getUint16(a,!0);a+=2;let o=r.getUint16(a,!0);a+=2;let s=r.getUint32(a,!0);a+=4;let c=y(e.subarray(t+a,t+a+i));a+=i;let l=e.subarray(t+a,t+a+s);a+=s,this.postProcessTag(n,c,o,l)}return n}};H.guid=_.MetadataObject;var U=class extends H{};U.guid=_.MetadataLibraryObject;var W=class e{static fromBuffer(t){return new e(t.length).get(t,0)}constructor(e){this.len=e}get(e,t){let n=new DataView(e.buffer,t),i=n.getUint8(0),a=n.getInt32(1,!0),o=5;for(;n.getUint16(o)!==0;)o+=2;let s=new r(o-5,`utf-16le`).get(e,5);for(;n.getUint16(o)!==0;)o+=2;let c=new r(o-5,`utf-16le`).get(e,5);return{type:p[i],format:s,description:c,size:a,data:e.slice(o+4)}}},G=(0,h.default)(`music-metadata:parser:ASF`),K=`asf`,q=class extends o{async parse(){let e=await this.tokenizer.readToken(D);if(!e.objectId.equals(_.HeaderObject))throw new E(`expected asf header; but was not found; got: ${e.objectId.str}`);try{await this.parseObjectHeader(e.numberOfHeaderObjects)}catch(e){G(`Error while parsing ASF: %s`,e)}}async parseObjectHeader(e){let t;do{let e=await this.tokenizer.readToken(O);switch(G(`header GUID=%s`,e.objectId.str),e.objectId.str){case j.guid.str:{let t=await this.tokenizer.readToken(new j(e));this.metadata.setFormat(`duration`,Number(t.playDuration/BigInt(1e3))/1e4-Number(t.preroll)/1e3),this.metadata.setFormat(`bitrate`,t.maximumBitrate);break}case M.guid.str:{let t=await this.tokenizer.readToken(new M(e));this.metadata.setFormat(`container`,`ASF/${t.streamType}`);break}case N.guid.str:{let e=await this.tokenizer.readToken(new N);await this.parseExtensionObject(e.extensionDataSize);break}case z.guid.str:t=await this.tokenizer.readToken(new z(e)),await this.addTags(t);break;case B.guid.str:t=await this.tokenizer.readToken(new B(e)),await this.addTags(t);break;case _.CodecListObject.str:{let e=await I(this.tokenizer);e.forEach(e=>{this.metadata.addStreamInfo({type:e.type.videoCodec?m.video:m.audio,codecName:e.codecName})});let t=e.filter(e=>e.type.audioCodec).map(e=>e.codecName).join(`/`);this.metadata.setFormat(`codec`,t);break}case _.StreamBitratePropertiesObject.str:await this.tokenizer.ignore(e.objectSize-O.len);break;case _.PaddingObject.str:G(`Padding: %s bytes`,e.objectSize-O.len),await this.tokenizer.ignore(e.objectSize-O.len);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${e.objectId.str}`),G(`Ignore ASF-Object-GUID: %s`,e.objectId.str),await this.tokenizer.readToken(new A(e))}}while(--e)}async addTags(e){await Promise.all(e.map(({id:e,value:t})=>this.metadata.addTag(K,e,t)))}async parseExtensionObject(e){do{let t=await this.tokenizer.readToken(O),n=t.objectSize-O.len;switch(t.objectId.str){case V.guid.str:await this.tokenizer.readToken(new V(t));break;case H.guid.str:{let e=await this.tokenizer.readToken(new H(t));await this.addTags(e);break}case U.guid.str:{let e=await this.tokenizer.readToken(new U(t));await this.addTags(e);break}case _.PaddingObject.str:await this.tokenizer.ignore(n);break;case _.CompatibilityObject.str:await this.tokenizer.ignore(n);break;case _.ASF_Index_Placeholder_Object.str:await this.tokenizer.ignore(n);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${t.objectId.str}`),await this.tokenizer.readToken(new A(t));break}e-=t.objectSize}while(e>0)}};export{q as AsfParser};