import{at as e}from"./index-DoTDNdOg.js";import{C as t,D as n,E as r,S as i,_ as a,m as o,o as s,s as c,t as l,v as u}from"./BasicParser-DI21ffqc.js";import{n as d}from"./core-B0hkJOfv.js";import"./Util-rPbNJ37b.js";import"./ID3v2Token-BbgdoPHz.js";import{i as f}from"./APEv2Parser-DErXEu7M.js";import"./ID3v1Parser-DZpVxopG.js";import{t as p}from"./ID3v2Parser-BtfRN05D.js";var m=e(c(),1);const h={len:12,get:(e,t)=>({chunkID:f.get(e,t),chunkSize:o.get(e,t+4)})};var g=(0,m.default)(`music-metadata:parser:aiff`),_=class extends s(`DSDIFF`){},v=class extends l{async parse(){let e=await this.tokenizer.readToken(h);if(e.chunkID!==`FRM8`)throw new _(`Unexpected chunk-ID`);this.metadata.setAudioOnly();let t=(await this.tokenizer.readToken(f)).trim();switch(t){case`DSD`:return this.metadata.setFormat(`container`,`DSDIFF/${t}`),this.metadata.setFormat(`lossless`,!0),this.readFmt8Chunks(e.chunkSize-BigInt(f.len));default:throw new _(`Unsupported DSDIFF type: ${t}`)}}async readFmt8Chunks(e){for(;e>=h.len;){let t=await this.tokenizer.readToken(h);g(`Chunk id=${t.chunkID}`),await this.readData(t),e-=BigInt(h.len)+t.chunkSize}}async readData(e){g(`Reading data of chunk[ID=${e.chunkID}, size=${e.chunkSize}]`);let r=this.tokenizer.position;switch(e.chunkID.trim()){case`FVER`:g(`DSDIFF version=${await this.tokenizer.readToken(t)}`);break;case`PROP`:if(await this.tokenizer.readToken(f)!==`SND `)throw new _(`Unexpected PROP-chunk ID`);await this.handleSoundPropertyChunks(e.chunkSize-BigInt(f.len));break;case`ID3`:{let t=d(await this.tokenizer.readToken(new n(Number(e.chunkSize))));await new p().parse(this.metadata,t,this.options);break}case`DSD`:this.metadata.format.numberOfChannels&&this.metadata.setFormat(`numberOfSamples`,Number(e.chunkSize*BigInt(8)/BigInt(this.metadata.format.numberOfChannels))),this.metadata.format.numberOfSamples&&this.metadata.format.sampleRate&&this.metadata.setFormat(`duration`,this.metadata.format.numberOfSamples/this.metadata.format.sampleRate);break;default:g(`Ignore chunk[ID=${e.chunkID}, size=${e.chunkSize}]`);break}let i=e.chunkSize-BigInt(this.tokenizer.position-r);i>0&&(g(`After Parsing chunk, remaining ${i} bytes`),await this.tokenizer.ignore(Number(i)))}async handleSoundPropertyChunks(e){for(g(`Parsing sound-property-chunks, remainingSize=${e}`);e>0;){let t=await this.tokenizer.readToken(h);g(`Sound-property-chunk[ID=${t.chunkID}, size=${t.chunkSize}]`);let n=this.tokenizer.position;switch(t.chunkID.trim()){case`FS`:{let e=await this.tokenizer.readToken(i);this.metadata.setFormat(`sampleRate`,e);break}case`CHNL`:{let e=await this.tokenizer.readToken(u);this.metadata.setFormat(`numberOfChannels`,e),await this.handleChannelChunks(t.chunkSize-BigInt(u.len));break}case`CMPR`:{let e=(await this.tokenizer.readToken(f)).trim(),t=await this.tokenizer.readToken(r),n=await this.tokenizer.readToken(new a(t,`ascii`));e===`DSD`&&(this.metadata.setFormat(`lossless`,!0),this.metadata.setFormat(`bitsPerSample`,1)),this.metadata.setFormat(`codec`,`${e} (${n})`);break}case`ABSS`:g(`ABSS ${await this.tokenizer.readToken(u)}:${await this.tokenizer.readToken(r)}:${await this.tokenizer.readToken(r)}.${await this.tokenizer.readToken(i)}`);break;case`LSCO`:g(`LSCO lsConfig=${await this.tokenizer.readToken(u)}`);break;default:g(`Unknown sound-property-chunk[ID=${t.chunkID}, size=${t.chunkSize}]`),await this.tokenizer.ignore(Number(t.chunkSize))}let o=t.chunkSize-BigInt(this.tokenizer.position-n);o>0&&(g(`After Parsing sound-property-chunk ${t.chunkSize}, remaining ${o} bytes`),await this.tokenizer.ignore(Number(o))),e-=BigInt(h.len)+t.chunkSize,g(`Parsing sound-property-chunks, remainingSize=${e}`)}if(this.metadata.format.lossless&&this.metadata.format.sampleRate&&this.metadata.format.numberOfChannels&&this.metadata.format.bitsPerSample){let e=this.metadata.format.sampleRate*this.metadata.format.numberOfChannels*this.metadata.format.bitsPerSample;this.metadata.setFormat(`bitrate`,e)}}async handleChannelChunks(e){g(`Parsing channel-chunks, remainingSize=${e}`);let t=[];for(;e>=f.len;){let n=await this.tokenizer.readToken(f);g(`Channel[ID=${n}]`),t.push(n),e-=BigInt(f.len)}return g(`Channels: ${t.join(`, `)}`),t}};export{v as DsdiffParser};