import{q as e}from"./index-CRYFRZmM.js";import{D as t,E as n,S as r,_ as i,o as a,s as o,u as s,v as c}from"./BasicParser-Difx2Y2A.js";import{i as l}from"./core-SrxPbndD.js";import{c as u,o as d,s as f}from"./Util-VcpxPVGx.js";import"./ID3v2Token-B-a7815c.js";import"./APEv2Parser-CsvJrojD.js";import"./ID3v1Parser-CNhY7Fm_.js";import"./ID3v2Parser-BzEAc8G9.js";import{t as p}from"./AbstractID3Parser-ByPXQ0Sp.js";var m=e(o(),1);const h={len:2,get:(e,t)=>{let n=d(e,t,0,3),r=d(e,t,6,1),i=d(e,t,7,9)/10;if(n>0)return{type:d(e,t,0,3),origin:d(e,t,3,3),adjustment:r?-i:i}}},g={len:27,get:(e,t)=>{let i=r.get(e,t+2);return{revision:d(e,t,0,4),vbr_method:d(e,t,4,4),lowpass_filter:100*n.get(e,t+1),track_peak:i===0?null:i/2**23,track_gain:h.get(e,6),album_gain:h.get(e,8),music_length:r.get(e,t+20),music_crc:n.get(e,t+24),header_crc:c.get(e,t+24)}}},_=new i(4,`ascii`),v=new i(6,`ascii`),y={len:4,get:(e,t)=>({frames:f(e,t,31),bytes:f(e,t,30),toc:f(e,t,29),vbrScale:f(e,t,28)})};async function b(e){let t=await e.readToken(y),n={numFrames:null,streamSize:null,vbrScale:null};if(t.frames&&(n.numFrames=await e.readToken(r)),t.bytes&&(n.streamSize=await e.readToken(r)),t.toc&&(n.toc=new Uint8Array(100),await e.readBuffer(n.toc)),t.vbrScale&&(n.vbrScale=await e.readToken(r)),await e.peekToken(new i(4,`ascii`))===`LAME`){await e.ignore(4),n.lame={version:await e.readToken(new i(5,`ascii`))};let t=n.lame.version.match(/\d+.\d+/g);if(t!==null){let r=t[0].split(`.`).map(e=>Number.parseInt(e,10));r[0]>=3&&r[1]>=90&&(n.lame.extended=await e.readToken(g))}}return n}var x=(0,m.default)(`music-metadata:parser:mpeg`),S=class extends a(`MPEG`){},C=1024,w={AudioObjectTypes:[`AAC Main`,`AAC LC`,`AAC SSR`,`AAC LTP`],SamplingFrequencies:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,null,null,-1]},T=[void 0,[`front-center`],[`front-left`,`front-right`],[`front-center`,`front-left`,`front-right`],[`front-center`,`front-left`,`front-right`,`back-center`],[`front-center`,`front-left`,`front-right`,`back-left`,`back-right`],[`front-center`,`front-left`,`front-right`,`back-left`,`back-right`,`LFE-channel`],[`front-center`,`front-left`,`front-right`,`side-left`,`side-right`,`back-left`,`back-right`,`LFE-channel`]],E=class e{constructor(t,n){this.bitrateIndex=null,this.sampRateFreqIndex=null,this.padding=null,this.privateBit=null,this.channelModeIndex=null,this.modeExtension=null,this.isOriginalMedia=null,this.version=null,this.bitrate=null,this.samplingRate=null,this.frameLength=0,this.versionIndex=d(t,n+1,3,2),this.layer=e.LayerDescription[d(t,n+1,5,2)],this.versionIndex>1&&this.layer===0?this.parseAdtsHeader(t,n):this.parseMpegHeader(t,n),this.isProtectedByCRC=!f(t,n+1,7)}calcDuration(e){return this.samplingRate==null?null:e*this.calcSamplesPerFrame()/this.samplingRate}calcSamplesPerFrame(){return e.samplesInFrameTable[this.version===1?0:1][this.layer]}calculateSideInfoLength(){if(this.layer!==3)return 2;if(this.channelModeIndex===3){if(this.version===1)return 17;if(this.version===2||this.version===2.5)return 9}else{if(this.version===1)return 32;if(this.version===2||this.version===2.5)return 17}return null}calcSlotSize(){return[null,4,1,1][this.layer]}parseMpegHeader(t,n){this.container=`MPEG`,this.bitrateIndex=d(t,n+2,0,4),this.sampRateFreqIndex=d(t,n+2,4,2),this.padding=f(t,n+2,6),this.privateBit=f(t,n+2,7),this.channelModeIndex=d(t,n+3,0,2),this.modeExtension=d(t,n+3,2,2),this.isCopyrighted=f(t,n+3,4),this.isOriginalMedia=f(t,n+3,5),this.emphasis=d(t,n+3,7,2),this.version=e.VersionID[this.versionIndex],this.channelMode=e.ChannelMode[this.channelModeIndex],this.codec=`MPEG ${this.version} Layer ${this.layer}`;let r=this.calcBitrate();if(!r)throw new S(`Cannot determine bit-rate`);if(this.bitrate=r*1e3,this.samplingRate=this.calcSamplingRate(),this.samplingRate==null)throw new S(`Cannot determine sampling-rate`)}parseAdtsHeader(e,t){x(`layer=0 => ADTS`),this.version=this.versionIndex===2?4:2,this.container=`ADTS/MPEG-${this.version}`;let n=d(e,t+2,0,2);this.codec=`AAC`,this.codecProfile=w.AudioObjectTypes[n],x(`MPEG-4 audio-codec=${this.codec}`);let r=d(e,t+2,2,4);this.samplingRate=w.SamplingFrequencies[r],x(`sampling-rate=${this.samplingRate}`),this.mp4ChannelConfig=T[d(e,t+2,7,3)],x(`channel-config=${this.mp4ChannelConfig?this.mp4ChannelConfig.join(`+`):`?`}`),this.frameLength=d(e,t+3,6,2)<<11}calcBitrate(){if(this.bitrateIndex===0||this.bitrateIndex===15)return null;if(this.version&&this.bitrateIndex){let t=10*Math.floor(this.version)+this.layer;return e.bitrate_index[this.bitrateIndex][t]}return null}calcSamplingRate(){return this.sampRateFreqIndex===3||this.version===null||this.sampRateFreqIndex==null?null:e.sampling_rate_freq_index[this.version][this.sampRateFreqIndex]}};E.SyncByte1=255,E.SyncByte2=224,E.VersionID=[2.5,null,2,1],E.LayerDescription=[0,3,2,1],E.ChannelMode=[`stereo`,`joint_stereo`,`dual_channel`,`mono`],E.bitrate_index={1:{11:32,12:32,13:32,21:32,22:8,23:8},2:{11:64,12:48,13:40,21:48,22:16,23:16},3:{11:96,12:56,13:48,21:56,22:24,23:24},4:{11:128,12:64,13:56,21:64,22:32,23:32},5:{11:160,12:80,13:64,21:80,22:40,23:40},6:{11:192,12:96,13:80,21:96,22:48,23:48},7:{11:224,12:112,13:96,21:112,22:56,23:56},8:{11:256,12:128,13:112,21:128,22:64,23:64},9:{11:288,12:160,13:128,21:144,22:80,23:80},10:{11:320,12:192,13:160,21:160,22:96,23:96},11:{11:352,12:224,13:192,21:176,22:112,23:112},12:{11:384,12:256,13:224,21:192,22:128,23:128},13:{11:416,12:320,13:256,21:224,22:144,23:144},14:{11:448,12:384,13:320,21:256,22:160,23:160}},E.sampling_rate_freq_index={1:{0:44100,1:48e3,2:32e3},2:{0:22050,1:24e3,2:16e3},2.5:{0:11025,1:12e3,2:8e3}},E.samplesInFrameTable=[[0,384,1152,1152],[0,384,1152,576]];var D={len:4,get:(e,t)=>new E(e,t)};function O(e){return`V${Math.floor((100-e)/10)}`}var k=class extends p{constructor(){super(...arguments),this.frameCount=0,this.syncFrameCount=-1,this.countSkipFrameData=0,this.totalDataLength=0,this.bitrates=[],this.offset=0,this.frame_size=0,this.crc=null,this.calculateEofDuration=!1,this.samplesPerFrame=null,this.buf_frame_header=new Uint8Array(4),this.mpegOffset=null,this.syncPeek={buf:new Uint8Array(C),len:0}}async postId3v2Parse(){this.metadata.setFormat(`lossless`,!1),this.metadata.setAudioOnly();try{let e=!1;for(;!e;)await this.sync(),e=await this.parseCommonMpegHeader()}catch(e){if(e instanceof l){if(x(`End-of-stream`),this.calculateEofDuration&&this.samplesPerFrame!==null){let e=this.frameCount*this.samplesPerFrame;if(this.metadata.setFormat(`numberOfSamples`,e),this.metadata.format.sampleRate){let t=e/this.metadata.format.sampleRate;x(`Calculate duration at EOF: ${t} sec.`,t),this.metadata.setFormat(`duration`,t)}}}else throw e}}finalize(){let e=this.metadata.format,t=!!this.metadata.native.ID3v1;if(this.mpegOffset!==null){if(e.duration&&this.tokenizer.fileInfo.size){let n=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);e.codecProfile&&e.codecProfile[0]===`V`&&this.metadata.setFormat(`bitrate`,n*8/e.duration)}if(this.tokenizer.fileInfo.size&&e.codecProfile===`CBR`){let n=this.tokenizer.fileInfo.size-this.mpegOffset-(t?128:0);if(this.frame_size!==null&&this.samplesPerFrame!==null){let t=Math.round(n/this.frame_size)*this.samplesPerFrame;if(this.metadata.setFormat(`numberOfSamples`,t),e.sampleRate&&!e.duration){let n=t/e.sampleRate;x(`Calculate CBR duration based on file size: %s`,n),this.metadata.setFormat(`duration`,n)}}}}}async sync(){let e=!1;for(;;){let t=0;if(this.syncPeek.len=await this.tokenizer.peekBuffer(this.syncPeek.buf,{length:C,mayBeLess:!0}),this.syncPeek.len<=163)throw new l;for(;;){if(e&&(this.syncPeek.buf[t]&224)==224){this.buf_frame_header[0]=E.SyncByte1,this.buf_frame_header[1]=this.syncPeek.buf[t],await this.tokenizer.ignore(t),x(`Sync at offset=${this.tokenizer.position-1}, frameCount=${this.frameCount}`),this.syncFrameCount===this.frameCount&&(x(`Re-synced MPEG stream, frameCount=${this.frameCount}`),this.frameCount=0,this.frame_size=0),this.syncFrameCount=this.frameCount;return}if(e=!1,t=this.syncPeek.buf.indexOf(E.SyncByte1,t),t===-1){if(this.syncPeek.len<this.syncPeek.buf.length)throw new l;await this.tokenizer.ignore(this.syncPeek.len);break}++t,e=!0}}}async parseCommonMpegHeader(){this.frameCount===0&&(this.mpegOffset=this.tokenizer.position-1),await this.tokenizer.peekBuffer(this.buf_frame_header.subarray(1),{length:3});let e;try{e=D.get(this.buf_frame_header,0)}catch(e){if(await this.tokenizer.ignore(1),e instanceof Error)return this.metadata.addWarning(`Parse error: ${e.message}`),!1;throw e}return await this.tokenizer.ignore(3),this.metadata.setFormat(`container`,e.container),this.metadata.setFormat(`codec`,e.codec),this.metadata.setFormat(`lossless`,!1),this.metadata.setFormat(`sampleRate`,e.samplingRate),this.frameCount++,e.version!==null&&e.version>=2&&e.layer===0?this.parseAdts(e):this.parseAudioFrameHeader(e)}async parseAudioFrameHeader(e){this.metadata.setFormat(`numberOfChannels`,e.channelMode===`mono`?1:2),this.metadata.setFormat(`bitrate`,e.bitrate),this.frameCount<20*1e4&&x(`offset=%s MP%s bitrate=%s sample-rate=%s`,this.tokenizer.position-4,e.layer,e.bitrate,e.samplingRate);let t=e.calcSlotSize();if(t===null)throw new S(`invalid slot_size`);let n=e.calcSamplesPerFrame();x(`samples_per_frame=${n}`);let r=n/8;if(e.bitrate!==null&&e.samplingRate!=null){let n=r*e.bitrate/e.samplingRate+(e.padding?t:0);this.frame_size=Math.floor(n)}if(this.audioFrameHeader=e,e.bitrate!==null&&this.bitrates.push(e.bitrate),this.frameCount===1)return this.offset=D.len,await this.skipSideInformation(),!1;if(this.frameCount===4){if(this.areAllSame(this.bitrates)){if(this.samplesPerFrame=n,this.metadata.setFormat(`codecProfile`,`CBR`),this.tokenizer.fileInfo.size)return!0}else if(this.metadata.format.duration)return!0;if(!this.options.duration)return!0}return this.options.duration&&this.frameCount===4&&(this.samplesPerFrame=n,this.calculateEofDuration=!0),this.offset=4,e.isProtectedByCRC?(await this.parseCrc(),!1):(await this.skipSideInformation(),!1)}async parseAdts(e){let t=new Uint8Array(3);if(await this.tokenizer.readBuffer(t),e.frameLength+=d(t,0,0,11),this.totalDataLength+=e.frameLength,this.samplesPerFrame=1024,e.samplingRate!==null){let t=e.samplingRate/this.samplesPerFrame,n=8*(this.frameCount===0?0:this.totalDataLength/this.frameCount)*t+.5;this.metadata.setFormat(`bitrate`,n),x(`frame-count=${this.frameCount}, size=${e.frameLength} bytes, bit-rate=${n}`)}if(await this.tokenizer.ignore(e.frameLength>7?e.frameLength-7:1),this.frameCount===3)if(this.metadata.setFormat(`codecProfile`,e.codecProfile),e.mp4ChannelConfig&&this.metadata.setFormat(`numberOfChannels`,e.mp4ChannelConfig.length),this.options.duration)this.calculateEofDuration=!0;else return!0;return!1}async parseCrc(){return this.crc=await this.tokenizer.readNumber(s),this.offset+=2,this.skipSideInformation()}async skipSideInformation(){if(this.audioFrameHeader){let e=this.audioFrameHeader.calculateSideInfoLength();if(e!==null){await this.tokenizer.readToken(new t(e)),this.offset+=e,await this.readXtraInfoHeader();return}}}async readXtraInfoHeader(){let e=await this.tokenizer.readToken(_);switch(this.offset+=_.len,e){case`Info`:return this.metadata.setFormat(`codecProfile`,`CBR`),this.readXingInfoHeader();case`Xing`:{let e=await this.readXingInfoHeader();if(e.vbrScale!==null){let t=O(e.vbrScale);this.metadata.setFormat(`codecProfile`,t)}return null}case`Xtra`:break;case`LAME`:{let e=await this.tokenizer.readToken(v);if(this.frame_size!==null&&this.frame_size>=this.offset+v.len)return this.offset+=v.len,this.metadata.setFormat(`tool`,`LAME ${e}`),await this.skipFrameData(this.frame_size-this.offset),null;this.metadata.addWarning(`Corrupt LAME header`);break}}let t=this.frame_size-this.offset;return t<0?this.metadata.addWarning(`Frame ${this.frameCount}corrupt: negative frameDataLeft`):await this.skipFrameData(t),null}async readXingInfoHeader(){let e=this.tokenizer.position,t=await b(this.tokenizer);if(this.offset+=this.tokenizer.position-e,t.lame&&(this.metadata.setFormat(`tool`,`LAME ${u(t.lame.version)}`),t.lame.extended&&(this.metadata.setFormat(`trackPeakLevel`,t.lame.extended.track_peak),t.lame.extended.track_gain&&this.metadata.setFormat(`trackGain`,t.lame.extended.track_gain.adjustment),t.lame.extended.album_gain&&this.metadata.setFormat(`albumGain`,t.lame.extended.album_gain.adjustment),this.metadata.setFormat(`duration`,t.lame.extended.music_length/1e3))),t.streamSize&&this.audioFrameHeader&&t.numFrames!==null){let e=this.audioFrameHeader.calcDuration(t.numFrames);return this.metadata.setFormat(`duration`,e),x(`Get duration from Xing header: %s`,this.metadata.format.duration),t}let n=this.frame_size-this.offset;return await this.skipFrameData(n),t}async skipFrameData(e){if(e<0)throw new S(`frame-data-left cannot be negative`);await this.tokenizer.ignore(e),this.countSkipFrameData+=e}areAllSame(e){let t=e[0];return e.every(e=>e===t)}};export{k as MpegParser};