import{at as e}from"./index-BC1ldwy9.js";import{D as t,E as n,O as r,S as i,_ as a,b as o,d as s,f as c,g as l,k as u,o as d,s as f,t as p,u as m,v as h,w as g}from"./BasicParser-BsBzhDj0.js";import"./core-B0hkJOfv.js";import{a as _,p as v}from"./Util-BP6ytFxS.js";import{i as y}from"./APEv2Parser-PmgGXUSV.js";import{t as b}from"./ID3v1Parser-5uVUu_F7.js";import{n as x}from"./types-BfLy63kP.js";var S=(0,e(f(),1).default)(`music-metadata:parser:MP4:atom`),C=class extends d(`MP4`){};const w={len:8,get:(e,t)=>{let n=i.get(e,t);if(n<0)throw new C(`Invalid atom header length`);return{length:BigInt(n),name:new a(4,`latin1`).get(e,t+4)}},put:(e,t,n)=>(i.put(e,t,Number(n.length)),y.put(e,t+4,n.name))},T=g,E={len:4,get:(e,t)=>({type:new a(4,`ascii`).get(e,t)})};var D=class{constructor(e,t,n){if(e<t)throw new C(`Atom ${n} expected to be ${t}, but specifies ${e} bytes long.`);e>t&&S(`Warning: atom ${n} expected to be ${t}, but was actually ${e} bytes long.`),this.len=e}},O={len:4,get:(e,t)=>{let n=i.get(e,t)-2082844800;return new Date(n*1e3)}},k=class extends D{constructor(e){super(e,24,`mdhd`)}get(e,t){return{version:n.get(e,t+0),flags:o.get(e,t+1),creationTime:O.get(e,t+4),modificationTime:O.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),language:h.get(e,t+20),quality:h.get(e,t+22)}}},A=class extends D{constructor(e){super(e,100,`mvhd`)}get(e,t){return{version:n.get(e,t),flags:o.get(e,t+1),creationTime:O.get(e,t+4),modificationTime:O.get(e,t+8),timeScale:i.get(e,t+12),duration:i.get(e,t+16),preferredRate:i.get(e,t+20),preferredVolume:h.get(e,t+24),previewTime:i.get(e,t+72),previewDuration:i.get(e,t+76),posterTime:i.get(e,t+80),selectionTime:i.get(e,t+84),selectionDuration:i.get(e,t+88),currentTime:i.get(e,t+92),nextTrackID:i.get(e,t+96)}}},ee=class{constructor(e){this.len=e}get(e,r){return{type:{set:n.get(e,r+0),type:o.get(e,r+1)},locale:o.get(e,r+4),value:new t(this.len-8).get(e,r+8)}}},te=class{constructor(e){this.len=e}get(e,t){return{version:n.get(e,t),flags:o.get(e,t+1),name:new a(this.len-4,`utf-8`).get(e,t+4)}}},ne=class{constructor(e){this.len=e}get(e,t){return{version:n.get(e,t),flags:o.get(e,t+1),creationTime:O.get(e,t+4),modificationTime:O.get(e,t+8),trackId:i.get(e,t+12),duration:i.get(e,t+20),layer:h.get(e,t+24),alternateGroup:h.get(e,t+26),volume:h.get(e,t+28)}}},j={len:8,get:(e,t)=>({version:n.get(e,t),flags:o.get(e,t+1),numberOfEntries:i.get(e,t+4)})},M=class{constructor(e){this.len=e}get(e,n){let r=this.len-12;return{dataFormat:y.get(e,n),dataReferenceIndex:h.get(e,n+10),description:r>0?new t(r).get(e,n+12):void 0}}},N=class{constructor(e){this.len=e}get(e,t){let n=j.get(e,t);t+=j.len;let r=[];for(let a=0;a<n.numberOfEntries;++a){let n=i.get(e,t);t+=i.len,r.push(new M(n-i.len).get(e,t)),t+=n}return{header:n,table:r}}};const P={len:8,get(e,t){return{version:m.get(e,t),revision:m.get(e,t+2),vendor:c.get(e,t+4)}}},F={len:12,get(e,t){return{numAudioChannels:m.get(e,t+0),sampleSize:m.get(e,t+2),compressionId:m.get(e,t+4),packetSize:m.get(e,t+6),sampleRate:h.get(e,t+8)+h.get(e,t+10)/1e4}}};var I=class{constructor(e,t){this.len=e,this.token=t}get(e,t){let n=c.get(e,t+4);return{version:l.get(e,t+0),flags:s.get(e,t+1),numberOfEntries:n,entries:W(e,this.token,t+8,this.len-8,n)}}};const L={len:8,get(e,t){return{count:c.get(e,t+0),duration:c.get(e,t+4)}}};var R=class extends I{constructor(e){super(e,L)}};const z={len:12,get(e,t){return{firstChunk:c.get(e,t),samplesPerChunk:c.get(e,t+4),sampleDescriptionId:c.get(e,t+8)}}};var B=class extends I{constructor(e){super(e,z)}},V=class{constructor(e){this.len=e}get(e,t){let n=c.get(e,t+8);return{version:l.get(e,t),flags:s.get(e,t+1),sampleSize:c.get(e,t+4),numberOfEntries:n,entries:W(e,c,t+12,this.len-12,n)}}},H=class extends I{constructor(e){super(e,c),this.len=e}},U=class{constructor(e){this.len=e}get(e,t){return new a(m.get(e,t+0),`utf-8`).get(e,t+2)}};function W(e,t,n,r,i){if(S(`remainingLen=${r}, numberOfEntries=${i} * token-len=${t.len}`),r===0)return[];if(r!==i*t.len)throw new C(`mismatch number-of-entries with remaining atom-length`);let a=[];for(let r=0;r<i;++r)a.push(t.get(e,n)),n+=t.len;return a}var G=class{constructor(e){this.len=e}get(e,t){let n=t+1,r={version:l.get(e,t),flags:{baseDataOffsetPresent:_(e,n+2,0),sampleDescriptionIndexPresent:_(e,n+2,1),defaultSampleDurationPresent:_(e,n+2,3),defaultSampleSizePresent:_(e,n+2,4),defaultSampleFlagsPresent:_(e,n+2,5),defaultDurationIsEmpty:_(e,n,0),defaultBaseIsMoof:_(e,n,1)},trackId:i.get(e,4)},a=8;return r.flags.baseDataOffsetPresent&&(r.baseDataOffset=g.get(e,a),a+=8),r.flags.sampleDescriptionIndexPresent&&(r.sampleDescriptionIndex=i.get(e,a),a+=4),r.flags.defaultSampleDurationPresent&&(r.defaultSampleDuration=i.get(e,a),a+=4),r.flags.defaultSampleSizePresent&&(r.defaultSampleSize=i.get(e,a),a+=4),r.flags.defaultSampleFlagsPresent&&(r.defaultSampleFlags=i.get(e,a)),r}},K=class{constructor(e){this.len=e}get(e,t){let n=t+1,r={version:l.get(e,t),flags:{dataOffsetPresent:_(e,n+2,0),firstSampleFlagsPresent:_(e,n+2,2),sampleDurationPresent:_(e,n+1,0),sampleSizePresent:_(e,n+1,1),sampleFlagsPresent:_(e,n+1,2),sampleCompositionTimeOffsetsPresent:_(e,n+1,3)},sampleCount:i.get(e,t+4),samples:[]},a=t+8;r.flags.dataOffsetPresent&&(r.dataOffset=i.get(e,a),a+=4),r.flags.firstSampleFlagsPresent&&(r.firstSampleFlags=i.get(e,a),a+=4);for(let t=0;t<r.sampleCount;++t){if(a>=this.len){S(`TrackRunBox size mismatch`);break}let t={};r.flags.sampleDurationPresent&&(t.sampleDuration=i.get(e,a),a+=4),r.flags.sampleSizePresent&&(t.sampleSize=i.get(e,a),a+=4),r.flags.sampleFlagsPresent&&(t.sampleFlags=i.get(e,a),a+=4),r.flags.sampleCompositionTimeOffsetsPresent&&(t.sampleCompositionTimeOffset=i.get(e,a),a+=4),r.samples.push(t)}return r}},q=class{constructor(e){this.len=e}get(e,t){t+1;let n=new a(4,`utf-8`);return{version:l.get(e,t),flags:o.get(e,t+1),componentType:n.get(e,t+4),handlerType:n.get(e,t+8),componentName:new a(this.len-28,`utf-8`).get(e,t+28)}}},J=class{constructor(e){this.len=e}get(e,t){let n=0,r=[];for(;n<this.len;)r.push(i.get(e,t+n)),n+=4;return r}},Y=(0,e(f(),1).default)(`music-metadata:parser:MP4:Atom`),X=class e{static async readAtom(t,n,r,i){let a=t.position;Y(`Reading next token on offset=${a}...`);let o=await t.readToken(w),s=o.length===1n;s&&(o.length=await t.readToken(T));let c=new e(o,s,r),l=c.getPayloadLength(i);return Y(`parse atom name=${c.atomPath}, extended=${c.extended}, offset=${a}, len=${c.header.length}`),await c.readData(t,n,l),c}constructor(e,t,n){this.header=e,this.extended=t,this.parent=n,this.children=[],this.atomPath=(this.parent?`${this.parent.atomPath}.`:``)+this.header.name}getHeaderLength(){return this.extended?16:8}getPayloadLength(e){return(this.header.length===0n?e:Number(this.header.length))-this.getHeaderLength()}async readAtoms(t,n,r){for(;r>0;){let i=await e.readAtom(t,n,this,r);this.children.push(i),r-=i.header.length===0n?r:Number(i.header.length)}}async readData(e,t,n){switch(this.header.name){case`moov`:case`udta`:case`mdia`:case`minf`:case`stbl`:case`<id>`:case`ilst`:case`tref`:case`moof`:return this.readAtoms(e,t,this.getPayloadLength(n));case`meta`:{let r=(await e.peekToken(w)).name===`hdlr`?0:4;return await e.ignore(r),this.readAtoms(e,t,this.getPayloadLength(n)-r)}default:return t(this,n)}}},Z=(0,e(f(),1).default)(`music-metadata:parser:MP4`),re=`iTunes`,Q={raw:{lossy:!1,format:`raw`},MAC3:{lossy:!0,format:`MACE 3:1`},MAC6:{lossy:!0,format:`MACE 6:1`},ima4:{lossy:!0,format:`IMA 4:1`},ulaw:{lossy:!0,format:`uLaw 2:1`},alaw:{lossy:!0,format:`uLaw 2:1`},Qclp:{lossy:!0,format:`QUALCOMM PureVoice`},".mp3":{lossy:!0,format:`MPEG-1 layer 3`},alac:{lossy:!1,format:`ALAC`},"ac-3":{lossy:!0,format:`AC-3`},mp4a:{lossy:!0,format:`MPEG-4/AAC`},mp4s:{lossy:!0,format:`MP4S`},c608:{lossy:!0,format:`CEA-608`},c708:{lossy:!0,format:`CEA-708`}};function $(e,t,n){return n.indexOf(e)===t}var ie=class e extends p{constructor(){super(...arguments),this.tracks=new Map,this.hasVideoTrack=!1,this.hasAudioTrack=!0,this.atomParsers={mvhd:async e=>{let t=await this.tokenizer.readToken(new A(e));this.metadata.setFormat(`creationTime`,t.creationTime),this.metadata.setFormat(`modificationTime`,t.modificationTime)},chap:async e=>{let t=this.getTrackDescription(),n=[];for(;e>=i.len;)n.push(await this.tokenizer.readNumber(i)),e-=i.len;t.chapterList=n},mdat:async e=>{if(this.options.includeChapters){let t=[...this.tracks.values()].filter(e=>e.chapterList);if(t.length===1){let n=t[0].chapterList,r=[...this.tracks.values()].filter(e=>n.indexOf(e.header.trackId)!==-1);if(r.length===1)return this.parseChapterTrack(r[0],t[0],e)}}await this.tokenizer.ignore(e)},ftyp:async e=>{let t=[];for(;e>0;){let n=await this.tokenizer.readToken(E);e-=E.len;let r=n.type.replace(/\W/g,``);r.length>0&&t.push(r)}Z(`ftyp: ${t.join(`/`)}`);let n=t.filter($).join(`/`);this.metadata.setFormat(`container`,n)},stsd:async e=>{let t=await this.tokenizer.readToken(new N(e)),n=this.getTrackDescription();n.soundSampleDescription=t.table.map(e=>this.parseSoundSampleDescription(e))},stsz:async e=>{let t=await this.tokenizer.readToken(new V(e)),n=this.getTrackDescription();n.sampleSize=t.sampleSize,n.sampleSizeTable=t.entries},date:async e=>{let t=await this.tokenizer.readToken(new a(e,`utf-8`));await this.addTag(`date`,t)}}}static read_BE_Integer(e,t){let n=(t?`INT`:`UINT`)+e.length*8+(e.length>1?`_BE`:``),i=r[n];if(!i)throw new C(`Token for integer type not found: "${n}"`);return Number(i.get(e,0))}async parse(){this.hasVideoTrack=!1,this.hasAudioTrack=!0,this.tracks.clear();let e=this.tokenizer.fileInfo.size||0;for(;!this.tokenizer.fileInfo.size||e>0;){try{if((await this.tokenizer.peekToken(w)).name===`\0\0\0\0`){let e=`Error at offset=${this.tokenizer.position}: box.id=0`;Z(e),this.addWarning(e);break}}catch(e){if(e instanceof Error){let t=`Error at offset=${this.tokenizer.position}: ${e.message}`;Z(t),this.addWarning(t)}else throw e;break}let t=await X.readAtom(this.tokenizer,(e,t)=>this.handleAtom(e,t),null,e);e-=t.header.length===BigInt(0)?e:Number(t.header.length)}let t=[];this.tracks.forEach(e=>{let n=[];e.soundSampleDescription.forEach(e=>{let t={},r=Q[e.dataFormat];if(r?(n.push(r.format),t.codecName=r.format):t.codecName=`<${e.dataFormat}>`,e.description){let{description:n}=e;n.sampleRate>0&&(t.type=x.audio,t.audio={samplingFrequency:n.sampleRate,bitDepth:n.sampleSize,channels:n.numAudioChannels})}this.metadata.addStreamInfo(t)}),n.length>=1&&t.push(n.join(`/`))}),t.length>0&&this.metadata.setFormat(`codec`,t.filter($).join(`+`));let n=[...this.tracks.values()].filter(e=>e.soundSampleDescription.length>=1&&e.soundSampleDescription[0].description&&e.soundSampleDescription[0].description.numAudioChannels>0);for(let e of n){if(e.media.header&&e.media.header.timeScale>0)if(e.sampleRate=e.media.header.timeScale,e.media.header.duration>0&&(Z(`Using duration defined on audio track`),e.samples=e.media.header.duration,e.duration=e.samples/e.sampleRate),e.fragments.length>0){Z(`Calculate duration defined in track fragments`);let t=0;e.sizeInBytes=0;for(let n of e.fragments)for(let r of n.trackRun.samples){let i=r.sampleDuration??n.header.defaultSampleDuration??0,a=r.sampleSize??n.header.defaultSampleSize??0;if(i===0)throw Error(`Missing sampleDuration and no defaultSampleDuration in track fragment header`);if(a===0)throw Error(`Missing sampleSize and no defaultSampleSize in track fragment header`);t+=i,e.sizeInBytes+=a}e.samples||=t,e.duration||=t/e.sampleRate}else e.sampleSizeTable.length>0&&(e.sizeInBytes=e.sampleSizeTable.reduce((e,t)=>e+t,0));let t=e.soundSampleDescription[0];t.description&&e.media.header&&(this.metadata.setFormat(`sampleRate`,t.description.sampleRate),this.metadata.setFormat(`bitsPerSample`,t.description.sampleSize),this.metadata.setFormat(`numberOfChannels`,t.description.numAudioChannels),e.media.header.timeScale===0&&e.timeToSampleTable.length>0&&(e.duration=e.timeToSampleTable.map(e=>e.count*e.duration).reduce((e,t)=>e+t)/t.description.sampleRate));let n=Q[t.dataFormat];n&&this.metadata.setFormat(`lossless`,!n.lossy)}if(n.length>=1){let e=n[0];e.duration&&(this.metadata.setFormat(`duration`,e.duration),e.sizeInBytes&&this.metadata.setFormat(`bitrate`,8*e.sizeInBytes/e.duration))}this.metadata.setFormat(`hasAudio`,this.hasAudioTrack),this.metadata.setFormat(`hasVideo`,this.hasVideoTrack)}async handleAtom(e,t){if(e.parent)switch(e.parent.header.name){case`ilst`:case`<id>`:return this.parseMetadataItemData(e);case`moov`:switch(e.header.name){case`trak`:return this.parseTrackBox(e);case`udta`:return this.parseTrackBox(e)}break;case`moof`:switch(e.header.name){case`traf`:return this.parseTrackFragmentBox(e)}}if(this.atomParsers[e.header.name])return this.atomParsers[e.header.name](t);Z(`No parser for atom path=${e.atomPath}, payload-len=${t}, ignoring atom`),await this.tokenizer.ignore(t)}getTrackDescription(){let e=[...this.tracks.values()];return e[e.length-1]}async addTag(e,t){await this.metadata.addTag(re,e,t)}addWarning(e){Z(`Warning: ${e}`),this.metadata.addWarning(e)}parseMetadataItemData(e){let n=e.header.name;return e.readAtoms(this.tokenizer,async(e,r)=>{let i=e.getPayloadLength(r);switch(e.header.name){case`data`:return this.parseValueAtom(n,e);case`name`:case`mean`:case`rate`:{let e=await this.tokenizer.readToken(new te(i));n+=`:${e.name}`;break}default:{let r=await this.tokenizer.readToken(new t(i));this.addWarning(`Unsupported meta-item: ${n}[${e.header.name}] => value=${v(r)} ascii=${u(r,`ascii`)}`)}}},e.getPayloadLength(0))}async parseValueAtom(t,r){let a=await this.tokenizer.readToken(new ee(Number(r.header.length)-w.len));if(a.type.set!==0)throw new C(`Unsupported type-set != 0: ${a.type.set}`);switch(a.type.type){case 0:switch(t){case`trkn`:case`disk`:{let e=n.get(a.value,3),r=n.get(a.value,5);await this.addTag(t,`${e}/${r}`);break}case`gnre`:{let e=b[n.get(a.value,1)-1];await this.addTag(t,e);break}case`rate`:{let e=u(a.value,`ascii`);await this.addTag(t,e);break}default:Z(`unknown proprietary value type for: ${r.atomPath}`)}break;case 1:case 18:await this.addTag(t,u(a.value));break;case 13:if(this.options.skipCovers)break;await this.addTag(t,{format:`image/jpeg`,data:Uint8Array.from(a.value)});break;case 14:if(this.options.skipCovers)break;await this.addTag(t,{format:`image/png`,data:Uint8Array.from(a.value)});break;case 21:await this.addTag(t,e.read_BE_Integer(a.value,!0));break;case 22:await this.addTag(t,e.read_BE_Integer(a.value,!1));break;case 65:await this.addTag(t,n.get(a.value,0));break;case 66:await this.addTag(t,h.get(a.value,0));break;case 67:await this.addTag(t,i.get(a.value,0));break;default:this.addWarning(`atom key=${t}, has unknown well-known-type (data-type): ${a.type.type}`)}}async parseTrackBox(e){let t={media:{},fragments:[]};await e.readAtoms(this.tokenizer,async(e,n)=>{let r=e.getPayloadLength(n);switch(e.header.name){case`chap`:t.chapterList=await this.tokenizer.readToken(new J(n));break;case`tkhd`:t.header=await this.tokenizer.readToken(new ne(r));break;case`hdlr`:t.handler=await this.tokenizer.readToken(new q(r)),t.isAudio=()=>t.handler.handlerType===`audi`||t.handler.handlerType===`soun`,t.isVideo=()=>t.handler.handlerType===`vide`,t.isAudio()?this.hasAudioTrack=!0:t.isVideo()&&(this.hasVideoTrack=!0);break;case`mdhd`:{let e=await this.tokenizer.readToken(new k(r));t.media.header=e;break}case`stco`:t.chunkOffsetTable=(await this.tokenizer.readToken(new H(r))).entries;break;case`stsc`:t.sampleToChunkTable=(await this.tokenizer.readToken(new B(r))).entries;break;case`stsd`:t.soundSampleDescription=(await this.tokenizer.readToken(new N(r))).table.map(e=>this.parseSoundSampleDescription(e));break;case`stts`:t.timeToSampleTable=(await this.tokenizer.readToken(new R(r))).entries;break;case`stsz`:{let e=await this.tokenizer.readToken(new V(r));t.sampleSize=e.sampleSize,t.sampleSizeTable=e.entries;break}case`dinf`:case`vmhd`:case`smhd`:Z(`Ignoring: ${e.header.name}`),await this.tokenizer.ignore(r);break;default:Z(`Unexpected track box: ${e.header.name}`),await this.tokenizer.ignore(r)}},e.getPayloadLength(0)),this.tracks.set(t.header.trackId,t)}parseTrackFragmentBox(e){let t;return e.readAtoms(this.tokenizer,async(e,n)=>{let r=e.getPayloadLength(n);switch(e.header.name){case`tfhd`:{let r=new G(e.getPayloadLength(n));t=await this.tokenizer.readToken(r);break}case`tfdt`:await this.tokenizer.ignore(r);break;case`trun`:{let e=new K(r),n=await this.tokenizer.readToken(e);t&&this.tracks.get(t.trackId)?.fragments.push({header:t,trackRun:n});break}default:Z(`Unexpected box: ${e.header.name}`),await this.tokenizer.ignore(r)}},e.getPayloadLength(0))}parseSoundSampleDescription(e){let t={dataFormat:e.dataFormat,dataReferenceIndex:e.dataReferenceIndex},n=0;if(e.description){let r=P.get(e.description,n);n+=P.len,r.version===0||r.version===1?t.description=F.get(e.description,n):Z(`Warning: sound-sample-description ${r} not implemented`)}return t}async parseChapterTrack(e,t,n){if(!e.sampleSize&&e.chunkOffsetTable.length!==e.sampleSizeTable.length)throw Error(`Expected equal chunk-offset-table & sample-size-table length.`);let r=[];for(let i=0;i<e.chunkOffsetTable.length&&n>0;++i){let a=e.timeToSampleTable.slice(0,i).reduce((e,t)=>e+t.duration,0),o=e.chunkOffsetTable[i]-this.tokenizer.position,s=e.sampleSize>0?e.sampleSize:e.sampleSizeTable[i];if(n-=o+s,n<0)throw new C(`Chapter chunk exceeding token length`);await this.tokenizer.ignore(o);let c=await this.tokenizer.readToken(new U(s));Z(`Chapter ${i+1}: ${c}`);let l={title:c,timeScale:e.media.header?e.media.header.timeScale:0,start:a,sampleOffset:this.findSampleOffset(t,this.tokenizer.position)};Z(`Chapter title=${l.title}, offset=${l.sampleOffset}/${t.header.duration}`),r.push(l)}this.metadata.setFormat(`chapters`,r),await this.tokenizer.ignore(n)}findSampleOffset(e,t){let n=0;for(;n<e.chunkOffsetTable.length&&e.chunkOffsetTable[n]<t;)++n;return this.getChunkDuration(n+1,e)}getChunkDuration(e,t){let n=0,r=t.timeToSampleTable[n].count,i=t.timeToSampleTable[n].duration,a=1,o=this.getSamplesPerChunk(a,t.sampleToChunkTable),s=0;for(;a<e;){let e=Math.min(r,o);s+=e*i,r-=e,o-=e,o===0?(++a,o=this.getSamplesPerChunk(a,t.sampleToChunkTable)):(++n,r=t.timeToSampleTable[n].count,i=t.timeToSampleTable[n].duration)}return s}getSamplesPerChunk(e,t){for(let n=0;n<t.length-1;++n)if(e>=t[n].firstChunk&&e<t[n+1].firstChunk)return t[n].samplesPerChunk;return t[t.length-1].samplesPerChunk}};export{ie as MP4Parser};