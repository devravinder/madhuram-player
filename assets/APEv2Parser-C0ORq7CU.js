import{q as e}from"./index-DXzd5qjx.js";import{A as t,C as n,D as r,_ as i,i as a,k as o,o as s,r as c,s as l,t as u,y as d}from"./BasicParser-CQ20OyPe.js";import{n as f}from"./core-SrxPbndD.js";import{i as p,t as m}from"./Util-DQbBdhOk.js";var h=/^[\x21-\x7eÂ©][\x20-\x7e\x00()]{3}/;const g={len:4,get:(e,t)=>{let n=o(e.subarray(t,t+g.len),`latin1`);if(!n.match(h))throw new c(`FourCC contains invalid characters: ${m(n)} "${n}"`);return n},put:(e,n,r)=>{let i=t(r,`latin1`);if(i.length!==4)throw new a(`Invalid length`);return e.set(i,n),n+4}},_={text_utf8:0,binary:1,external_info:2,reserved:3},v={len:52,get:(e,t)=>({ID:g.get(e,t),version:n.get(e,t+4)/1e3,descriptorBytes:n.get(e,t+8),headerBytes:n.get(e,t+12),seekTableBytes:n.get(e,t+16),headerDataBytes:n.get(e,t+20),apeFrameDataBytes:n.get(e,t+24),apeFrameDataBytesHigh:n.get(e,t+28),terminatingDataBytes:n.get(e,t+32),fileMD5:new r(16).get(e,t+36)})},y={len:24,get:(e,t)=>({compressionLevel:d.get(e,t),formatFlags:d.get(e,t+2),blocksPerFrame:n.get(e,t+4),finalFrameBlocks:n.get(e,t+8),totalFrames:n.get(e,t+12),bitsPerSample:d.get(e,t+16),channel:d.get(e,t+18),sampleRate:n.get(e,t+20)})},b={len:32,get:(e,t)=>({ID:new i(8,`ascii`).get(e,t),version:n.get(e,t+8),size:n.get(e,t+12),fields:n.get(e,t+16),flags:S(n.get(e,t+20))})},x={len:8,get:(e,t)=>({size:n.get(e,t),flags:S(n.get(e,t+4))})};function S(e){return{containsHeader:C(e,31),containsFooter:C(e,30),isHeader:C(e,29),readOnly:C(e,0),dataType:(e&6)>>1}}function C(e,t){return(e&1<<t)!=0}var w=(0,e(l(),1).default)(`music-metadata:parser:APEv2`),T=`APEv2`,E=`APETAGEX`,D=class extends s(`APEv2`){};function O(e,t,n){return new k(e,t,n).tryParseApeHeader()}var k=class e extends u{constructor(){super(...arguments),this.ape={}}static calculateDuration(e){let t=e.totalFrames>1?e.blocksPerFrame*(e.totalFrames-1):0;return t+=e.finalFrameBlocks,t/e.sampleRate}static async findApeFooterOffset(e,t){let n=new Uint8Array(b.len),r=e.position;if(t<=b.len){w(`Offset is too small to read APE footer: offset=${t}`);return}if(t>b.len){await e.readBuffer(n,{position:t-b.len}),e.setPosition(r);let i=b.get(n,0);if(i.ID===`APETAGEX`)return i.flags.isHeader?w(`APE Header found at offset=${t-b.len}`):(w(`APE Footer found at offset=${t-b.len}`),t-=i.size),{footer:i,offset:t}}}static parseTagFooter(t,n,r){let i=b.get(n,n.length-b.len);if(i.ID!==E)throw new D(`Unexpected APEv2 Footer ID preamble value`);return f(n),new e(t,f(n),r).parseTags(i)}async tryParseApeHeader(){if(this.tokenizer.fileInfo.size&&this.tokenizer.fileInfo.size-this.tokenizer.position<b.len){w(`No APEv2 header found, end-of-file reached`);return}let t=await this.tokenizer.peekToken(b);if(t.ID===E)return await this.tokenizer.ignore(b.len),this.parseTags(t);if(w(`APEv2 header not found at offset=${this.tokenizer.position}`),this.tokenizer.fileInfo.size){let t=this.tokenizer.fileInfo.size-this.tokenizer.position,n=new Uint8Array(t);return await this.tokenizer.readBuffer(n),e.parseTagFooter(this.metadata,n,this.options)}}async parse(){let e=await this.tokenizer.readToken(v);if(e.ID!==`MAC `)throw new D(`Unexpected descriptor ID`);this.ape.descriptor=e;let t=e.descriptorBytes-v.len,n=await(t>0?this.parseDescriptorExpansion(t):this.parseHeader());return this.metadata.setAudioOnly(),await this.tokenizer.ignore(n.forwardBytes),this.tryParseApeHeader()}async parseTags(e){let t=new Uint8Array(256),n=e.size-b.len;w(`Parse APE tags at offset=${this.tokenizer.position}, size=${n}`);for(let r=0;r<e.fields;r++){if(n<x.len){this.metadata.addWarning(`APEv2 Tag-header: ${e.fields-r} items remaining, but no more tag data to read.`);break}let a=await this.tokenizer.readToken(x);n-=x.len+a.size,await this.tokenizer.peekBuffer(t,{length:Math.min(t.length,n)});let s=p(t),c=await this.tokenizer.readToken(new i(s,`ascii`));switch(await this.tokenizer.ignore(1),n-=c.length+1,a.flags.dataType){case _.text_utf8:{let e=(await this.tokenizer.readToken(new i(a.size,`utf8`))).split(/\x00/g);await Promise.all(e.map(e=>this.metadata.addTag(T,c,e)));break}case _.binary:if(this.options.skipCovers)await this.tokenizer.ignore(a.size);else{let e=new Uint8Array(a.size);await this.tokenizer.readBuffer(e),s=p(e);let t=o(e.subarray(0,s),`utf-8`),n=e.subarray(s+1);await this.metadata.addTag(T,c,{description:t,data:n})}break;case _.external_info:w(`Ignore external info ${c}`),await this.tokenizer.ignore(a.size);break;case _.reserved:w(`Ignore external info ${c}`),this.metadata.addWarning(`APEv2 header declares a reserved datatype for "${c}"`),await this.tokenizer.ignore(a.size);break}}}async parseDescriptorExpansion(e){return await this.tokenizer.ignore(e),this.parseHeader()}async parseHeader(){let t=await this.tokenizer.readToken(y);if(this.metadata.setFormat(`lossless`,!0),this.metadata.setFormat(`container`,`Monkey's Audio`),this.metadata.setFormat(`bitsPerSample`,t.bitsPerSample),this.metadata.setFormat(`sampleRate`,t.sampleRate),this.metadata.setFormat(`numberOfChannels`,t.channel),this.metadata.setFormat(`duration`,e.calculateDuration(t)),!this.ape.descriptor)throw new D(`Missing APE descriptor`);return{forwardBytes:this.ape.descriptor.seekTableBytes+this.ape.descriptor.headerDataBytes+this.ape.descriptor.apeFrameDataBytes+this.ape.descriptor.terminatingDataBytes}}};export{g as i,D as n,O as r,k as t};